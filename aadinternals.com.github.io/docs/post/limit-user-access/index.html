<!DOCTYPE html>
<html lang="en-gb">
<head>
<meta charset="UTF-8">
<meta http-equiv="cache-control" content="no-cache"> 
<meta http-equiv="expires" content="0"> 
<meta http-equiv="pragma" content="no-cache">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Block user access to Azure AD PowerShell and Graph API Explorer</title>
<meta name="description" content="The site for Microsoft 365 and Azure AD administrators">
<meta name="generator" content="Hugo 0.39" />
<meta property="og:title" content="Block user access to Azure AD PowerShell and Graph API Explorer" />
<meta property="og:description" content="By default, any user of Office 365 or Azure AD tenant can read the content of Azure AD using PowerShell and Graph API Explorer.
This is a serious security issue because users have undetectable access to other users&rsquo; personal data,
which violates for instance GDPR. In this blog, I&rsquo;ll tell how to prevent the access.

" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://o365blog.com/post/limit-user-access/" />



<meta property="article:published_time" content="2018-08-27T00:00:00&#43;00:00"/>

<meta property="article:modified_time" content="2021-11-09T00:00:00&#43;00:00"/>











<link rel="dns-prefetch" href="//fonts.googleapis.com" />
<link rel="dns-prefetch" href="//fonts.gstatic.com" />

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400italic,700" type="text/css" media="all" />
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet">
<link rel="stylesheet" href="/css/style.css" type="text/css" media="all" />
<script type="text/javascript" src="/js/scripts.js"></script>
<script type="text/javascript" src="/js/tools.js"></script>

<link rel="apple-touch-icon-precomposed" sizes="57x57" href="/images/apple-touch-icon-57x57.png" />
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114.png" />
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72.png" />
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144.png" />
<link rel="apple-touch-icon-precomposed" sizes="60x60" href="/images/apple-touch-icon-60x60.png" />
<link rel="apple-touch-icon-precomposed" sizes="120x120" href="/images/apple-touch-icon-120x120.png" />
<link rel="apple-touch-icon-precomposed" sizes="76x76" href="/images/apple-touch-icon-76x76.png" />
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="/images/apple-touch-icon-152x152.png" />
<link rel="icon" type="image/png" href="/images/favicon-196x196.png" sizes="196x196" />
<link rel="icon" type="image/png" href="/images/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32" />
<link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16" />
<link rel="icon" type="image/png" href="/images/favicon-128.png" sizes="128x128" />
<meta name="application-name" content="&nbsp;"/>
<meta name="msapplication-TileColor" content="#FFFFFF" />
<meta name="msapplication-TileImage" content="/images/mstile-144x144.png" />
<meta name="msapplication-square70x70logo" content="/images/mstile-70x70.png" />
<meta name="msapplication-square150x150logo" content="/images/mstile-150x150.png" />
<meta name="msapplication-wide310x150logo" content="/images/mstile-310x150.png" />
<meta name="msapplication-square310x310logo" content="/images/mstile-310x310.png" />


<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-61454000-4', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>

</head>
<body class="body body-right-sidebar mobile" itemscope="itemscope" itemtype="http://schema.org/WebPage">
	<div class="container container-outer">
		<header class="header" itemscope="itemscope" itemtype="http://schema.org/WPHeader">
		
			<div class="container container-inner clearfix">
			
				<div class="logo" role="banner" itemscope="itemscope" itemtype="http://schema.org/Brand">
				
					<a class="logo__link" href="/" title="Office 365 blog" rel="home">
						<img src="/images/favicon-96x96.png"><h1 class="logo__title">Office 365 blog</h1>
						<h2 class="logo__tagline">Everything about Microsoft 365 security</h2>
					</a>
				</div>
			</div>
			
<nav class="menu" itemscope="itemscope" itemtype="http://schema.org/SiteNavigationElement">
	<ul class="menu__list">
		<li class="menu__item "><a class="menu__link" href="/aadkillchain/">AAD &amp; M365 KILL CHAIN</a></li>
		<li class="menu__item "><a class="menu__link" href="/aadinternals/">AAD INTERNALS</a></li>
		<li class="menu__item "><a class="menu__link" href="/links/">LINKS</a></li>
		<li class="menu__item "><a class="menu__link" href="/powershell/">POWERSHELL</a></li>
		<li class="menu__item "><a class="menu__link" href="/talks/">TALKS</a></li>
		<li class="menu__item "><a class="menu__link" href="/tools/">TOOLS</a></li>
	</ul>
</nav>

		</header>
		<div class="wrapper clearfix">

<main class="main-content content" role="main" itemprop="mainContentOfPage">
	<article class="post">
		<header class="post__header clearfix">
			<h1 class="post__title">Block user access to Azure AD PowerShell and Graph API Explorer</h1>
			<p class="post__meta meta">
				<svg class="icon icon-time" height="14" viewBox="0 0 16 16" width="14" xmlns="http://www.w3.org/2000/svg"><path d="m8-.0000003c-4.4 0-8 3.6-8 8 0 4.4000003 3.6 8.0000003 8 8.0000003 4.4 0 8-3.6 8-8.0000003 0-4.4-3.6-8-8-8zm0 14.4000003c-3.52 0-6.4-2.88-6.4-6.4000003 0-3.52 2.88-6.4 6.4-6.4 3.52 0 6.4 2.88 6.4 6.4 0 3.5200003-2.88 6.4000003-6.4 6.4000003zm.4-10.4000003h-1.2v4.8l4.16 2.5600003.64-1.04-3.6-2.1600003z"/></svg>
				<time class="post__meta-date" datetime="2018-08-27T00:00:00">August 27, 2018</time>
					<time class="post__meta-lastmod" datetime="2021-11-09T00:00:00"> (Last Modified: November 09, 2021)</time>
				<span class="post__meta-categories meta-categories">
					<svg class="icon icon-category" height="16" viewBox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="m7 2l1 2h8v11h-16v-13z"/></svg>
					<a class="meta-categories__link" href="/categories/blog" rel="category">blog</a></span>
			</p>
			<div class="post__tags tags clearfix">
<ul class="tags__list">
	<li class="tags__item"><a class="tags__link" href="http://twitter.com/intent/tweet?url=http%3a%2f%2fo365blog.com%2fpost%2flimit-user-access%2f&text=Block%20user%20access%20to%20Azure%20AD%20PowerShell%20and%20Graph%20API%20Explorer&tw_p=tweetbutton" title="Share in Twitter" target="_blank" rel="nofollow"><i class="fa fa-twitter" aria-hidden="true"></i></a></li>
	<li class="tags__item"><a class="tags__link" href="https://www.linkedin.com/shareArticle?url=http%3a%2f%2fo365blog.com%2fpost%2flimit-user-access%2f&mini=true&title=Block%20user%20access%20to%20Azure%20AD%20PowerShell%20and%20Graph%20API%20Explorer&summary=&source=o365blog.com" title="Share in LinkedIn" target="_blank" rel="nofollow"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li>
</ul>
</div>
		</header>
		<div class="post__content clearfix">
			<figure class="post__thumbnail">
				<img src="/images/posts/limit-user-access.png" alt="Block user access to Azure AD PowerShell and Graph API Explorer">
			</figure>
				<nav id="TableOfContents">
<ul>
<li><a href="#azure-ad-powershell-access">Azure AD PowerShell access</a>
<ul>
<li><a href="#method-1-block-the-access-to-others-data">Method 1: Block the access to others data</a></li>
<li><a href="#method-2-block-the-access-for-msol-powershell-module">Method 2: Block the access for Msol PowerShell module</a></li>
</ul></li>
<li><a href="#azure-ad-graph-explorers">Azure AD Graph Explorers</a>
<ul>
<li><a href="#azure-ad-graph-explorer">Azure AD Graph Explorer</a></li>
<li><a href="#microsoft-graph-explorer">Microsoft Graph Explorer</a></li>
<li><a href="#how-to-block-access-to-graph-apis">How to block access to Graph APIs</a>
<ul>
<li><a href="#block-users-access-to-others-information">Block users&rsquo; access to others information</a></li>
<li><a href="#disable-graph-api-explorers">Disable Graph API Explorers</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
			<p>By default, any user of Office 365 or Azure AD tenant can read the content of Azure AD using PowerShell and Graph API Explorer.
This is a serious security issue because users have undetectable access to other users&rsquo; personal data,
which violates for instance GDPR. In this blog, I&rsquo;ll tell how to prevent the access.</p>

<p></p>

<h1 id="azure-ad-powershell-access">Azure AD PowerShell access</h1>

<p>As I described in my earlier <a href="/post/o365-gdpr/#powershell" target="_blank">blog post</a>, any user of
Office 365 or Azure AD tenant can access Azure AD and, for instance, export the whole directory and see who has admin rights.</p>

<p>Quite often when I discuss this issue with other administrators, they argue that this is quite similar to the on-premises AD, where users also
have access to the directory. Well, that is true but <strong>what is the real scenario where regular users do need to have access to admin tools?</strong>
I don&rsquo;t know any of such situation. Also, as far as I know, Google doesn&rsquo;t provide such access to their directory..</p>

<p>So, how do we block regular users PowerShell access to Azure AD?</p>

<h2 id="method-1-block-the-access-to-others-data">Method 1: Block the access to others data</h2>

<p>Run the following command as Global Admin, and you&rsquo;re done!</p>

<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="c"># Connect to Azure AD </span>
<span class="nb">Connect-MsolService</span>

<span class="c"># Disable users&#39; permission to read others data</span>
<span class="nb">Set-MsolCompanySettings</span> <span class="n">-UsersPermissionToReadOtherUsersEnabled</span> <span class="nv">$false</span></code></pre></div>

<p>To be more specific, users still do have PowerShell access to Azure AD but they are not able to read other users&rsquo; information.
Now, when users are trying to read Azure AD using any of the following commands:
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="c"># Export all AAD users to xml file</span>
<span class="nb">Get-MsolUser</span> <span class="p">|</span> <span class="nb">Export-Clixml</span> <span class="n">-Path</span> <span class="n">users</span><span class="p">.</span><span class="n">xml</span>

<span class="c"># List all Global Administrators</span>
<span class="nb">Get-MsolRoleMember</span> <span class="n">-RoleObjectId</span> <span class="p">(</span><span class="nb">Get-MsolRole</span> <span class="n">-RoleName</span> <span class="s2">&#34;Company Administrator&#34;</span><span class="p">).</span><span class="n">ObjectId</span></code></pre></div></p>

<p>They will get error similar to this:</p>

<pre><code>Get-MsolUser : Access Denied. You do not have permissions to call this cmdlet.
</code></pre>

<p></span></p>

<p><strong>NOTE:</strong> As pointed out by <a href="https://twitter.com/nestafo" target="_blank">@nestafo</a> and <a href="https://twitter.com/loukkis" target="_blank">@loukkis</a>,
disabling user access to others&rsquo; information causes problems in <a href="https://docs.microsoft.com/en-us/microsoftteams/known-issues" target="_blank">Teams</a> and Planner:
users will not able to add new members.</p>

<h2 id="method-2-block-the-access-for-msol-powershell-module">Method 2: Block the access for Msol PowerShell module</h2>

<p>Since version 0.4.3, the access for Msol PowerShell module can be blocked for all users.</p>

<p><strong>Note!</strong> This does not block Azure AD PowerShell module, so.. :man_facepalming:</p>

<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="c"># Get the access token</span>
<span class="nb">Get-AADIntAccessTokenForMSGraph</span> <span class="n">-SaveToCache</span>

<span class="c"># Disable the Msol PowerShell module access</span>
<span class="nb">Disable-AADIntTenantMsolAccess</span>

<span class="c"># Check the settings after 10 seconds or so.</span>
<span class="nb">Get-AADIntTenantAuthPolicy</span> <span class="p">|</span> <span class="n">Select</span> <span class="n">block</span><span class="p">*</span></code></pre></div>

<p><strong>Output:</strong></p>

<pre><code>blockMsolPowerShell
-------------------
              True
</code></pre>

<p>Now, when users (including admins) are trying to use any cmdlets of Msol PowerShell module they will get error similar to this:</p>

<pre><code>Get-MsolUser : Access Denied. You do not have permissions to call this cmdlet.
</code></pre>

<p>Also, most of the AADInternals functions utilising AAD Graph API will get the following error:</p>

<pre><code>No users are allowed to use Msol PowerShell to access this tenant.
</code></pre>

<h1 id="azure-ad-graph-explorers">Azure AD Graph Explorers</h1>

<p><a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/active-directory-graph-api" target="_blank">Azure Active Directory Graph API</a> and <a href="https://developer.microsoft.com/en-us/graph" target="_blank">Microsoft Graph</a>
are REST APIs for accessing Azure AD. To use them, one must register an app to Azure AD and assign permissions to it.
To do that, you will need admin rights, such as Global Administrator, to Azure AD.
In other words, users are not able to access Azure AD using their own apps, unless administrators allow them to do so.</p>

<p>Microsoft has developed API explorers to ease the development of apps using Graph APIs. From technical point-of-view these
explorers are apps, that need to be given access to Azure AD tenant. However, the problem is that <strong>these API explorers are
already authorised by Microsoft to access all Azure AD tenants!</strong></p>

<h2 id="azure-ad-graph-explorer">Azure AD Graph Explorer</h2>

<p>Azure AD Graph Explorer can be found <a href="https://graphexplorer.azurewebsites.net" target="_blank">here</a>.</p>

<p>To use the API, the user needs to login:
<img src="/images/posts/adgraph-01.png" alt="alt text" /></p>

<p>After successful login, the user is asked to grant permissions for the Graph explorer:</p>

<p><img src="/images/posts/adgraph-02.png" alt="alt text" /></p>

<p>To get the list of users, one can use the following url in explorer:</p>

<pre><code>https://graph.windows.net/myorganization/users
</code></pre>

<p>As a result, all users are returned in JSON.</p>

<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="nt">&#34;odata.metadata&#34;</span><span class="p">:</span> <span class="s2">&#34;https://graph.windows.net/myorganization/$metadata#directoryObjects/Microsoft.DirectoryServices.User&#34;</span><span class="p">,</span>
    <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&#34;odata.type&#34;</span><span class="p">:</span> <span class="s2">&#34;Microsoft.DirectoryServices.User&#34;</span><span class="p">,</span>
            <span class="nt">&#34;objectType&#34;</span><span class="p">:</span> <span class="s2">&#34;User&#34;</span><span class="p">,</span>
            <span class="nt">&#34;objectId&#34;</span><span class="p">:</span> <span class="s2">&#34;584e8bb7-3ed3-45c3-883a-33260951c59a&#34;</span><span class="p">,</span>
            <span class="nt">&#34;deletionTimestamp&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nt">&#34;accountEnabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nt">&#34;ageGroup&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nt">&#34;assignedLicenses&#34;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="nt">&#34;assignedPlans&#34;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="nt">&#34;city&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nt">&#34;companyName&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nt">&#34;consentProvidedForMinor&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nt">&#34;country&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nt">&#34;createdDateTime&#34;</span><span class="p">:</span> <span class="s2">&#34;2018-06-26T11:04:14Z&#34;</span><span class="p">,</span>
            <span class="nt">&#34;creationType&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nt">&#34;department&#34;</span><span class="p">:</span> <span class="s2">&#34;Retail&#34;</span><span class="p">,</span>
            <span class="nt">&#34;dirSyncEnabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nt">&#34;displayName&#34;</span><span class="p">:</span> <span class="s2">&#34;Adele Vance&#34;</span><span class="p">,</span>
            <span class="nt">&#34;employeeId&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nt">&#34;facsimileTelephoneNumber&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nt">&#34;givenName&#34;</span><span class="p">:</span> <span class="s2">&#34;Adele&#34;</span><span class="p">,</span>
            <span class="nt">&#34;immutableId&#34;</span><span class="p">:</span> <span class="s2">&#34;Ptog2uWbakyjs8UFXuc4yQ==&#34;</span><span class="p">,</span>
            <span class="nt">&#34;isCompromised&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nt">&#34;jobTitle&#34;</span><span class="p">:</span> <span class="s2">&#34;Retail Manager&#34;</span><span class="p">,</span>
            <span class="nt">&#34;lastDirSyncTime&#34;</span><span class="p">:</span> <span class="s2">&#34;2018-06-26T11:04:16Z&#34;</span><span class="p">,</span>
            <span class="nt">&#34;legalAgeGroupClassification&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nt">&#34;mail&#34;</span><span class="p">:</span> <span class="s2">&#34;AdeleV@demo.o365life.com&#34;</span><span class="p">,</span>
            <span class="nt">&#34;mailNickname&#34;</span><span class="p">:</span> <span class="s2">&#34;AdeleV&#34;</span><span class="p">,</span>
            <span class="nt">&#34;mobile&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nt">&#34;onPremisesDistinguishedName&#34;</span><span class="p">:</span> <span class="s2">&#34;CN=Adele Vance,OU=Sales and Marketing,OU=DomainUsers,DC=o365life,DC=com&#34;</span><span class="p">,</span>
            <span class="nt">&#34;onPremisesSecurityIdentifier&#34;</span><span class="p">:</span> <span class="s2">&#34;S-1-5-21-3277080990-2629470435-924441437-1157&#34;</span><span class="p">,</span>
            <span class="nt">&#34;otherMails&#34;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="nt">&#34;passwordPolicies&#34;</span><span class="p">:</span> <span class="s2">&#34;DisablePasswordExpiration&#34;</span><span class="p">,</span>
            <span class="nt">&#34;passwordProfile&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nt">&#34;physicalDeliveryOfficeName&#34;</span><span class="p">:</span> <span class="s2">&#34;18/2111&#34;</span><span class="p">,</span>
            <span class="nt">&#34;postalCode&#34;</span><span class="p">:</span> <span class="s2">&#34;98004&#34;</span><span class="p">,</span>
            <span class="nt">&#34;preferredLanguage&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nt">&#34;provisionedPlans&#34;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="nt">&#34;provisioningErrors&#34;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="nt">&#34;proxyAddresses&#34;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&#34;smtp:AdeleV@demoO365Life.onmicrosoft.com&#34;</span><span class="p">,</span>
                <span class="s2">&#34;SMTP:AdeleV@demo.o365life.com&#34;</span>
            <span class="p">],</span>
            <span class="nt">&#34;refreshTokensValidFromDateTime&#34;</span><span class="p">:</span> <span class="s2">&#34;2017-10-03T04:44:44Z&#34;</span><span class="p">,</span>
            <span class="nt">&#34;showInAddressList&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nt">&#34;signInNames&#34;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="nt">&#34;sipProxyAddress&#34;</span><span class="p">:</span> <span class="s2">&#34;AdeleV@demo.o365life.com&#34;</span><span class="p">,</span>
            <span class="nt">&#34;state&#34;</span><span class="p">:</span> <span class="s2">&#34;WA&#34;</span><span class="p">,</span>
            <span class="nt">&#34;streetAddress&#34;</span><span class="p">:</span> <span class="s2">&#34;205 108th Ave. NE, Suite 400&#34;</span><span class="p">,</span>
            <span class="nt">&#34;surname&#34;</span><span class="p">:</span> <span class="s2">&#34;Vance&#34;</span><span class="p">,</span>
            <span class="nt">&#34;telephoneNumber&#34;</span><span class="p">:</span> <span class="s2">&#34;+1 425 555 0109&#34;</span><span class="p">,</span>
            <span class="nt">&#34;thumbnailPhoto@odata.mediaContentType&#34;</span><span class="p">:</span> <span class="s2">&#34;image/Jpeg&#34;</span><span class="p">,</span>
            <span class="nt">&#34;usageLocation&#34;</span><span class="p">:</span> <span class="s2">&#34;FI&#34;</span><span class="p">,</span>
            <span class="nt">&#34;userIdentities&#34;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="nt">&#34;userPrincipalName&#34;</span><span class="p">:</span> <span class="s2">&#34;AdeleV@demo.o365life.com&#34;</span><span class="p">,</span>
            <span class="nt">&#34;userState&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nt">&#34;userStateChangedOn&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nt">&#34;userType&#34;</span><span class="p">:</span> <span class="s2">&#34;Member&#34;</span>
        <span class="p">}</span>
		<span class="p">]</span>
<span class="p">}</span></code></pre></div>

<h2 id="microsoft-graph-explorer">Microsoft Graph Explorer</h2>

<p>Microsoft Graph Explorer can be found <a href="https://developer.microsoft.com/en-us/graph/graph-explorer" target="_blank">here</a>.</p>

<p>To use the API, the user needs to login:
<img src="/images/posts/msgraph-01.png" alt="alt text" /></p>

<p>After successful login, the user is asked to grant permissions for the Graph explorer:</p>

<p><img src="/images/posts/msgraph-02.png" alt="alt text" /></p>

<p>To get the list of users, one can use the following url in explorer:</p>

<pre><code>https://graph.microsoft.com/v1.0/users
</code></pre>

<p>As a result, all users are returned in JSON.</p>

<p><div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="nt">&#34;@odata.context&#34;</span><span class="p">:</span> <span class="s2">&#34;https://graph.microsoft.com/v1.0/$metadata#users&#34;</span><span class="p">,</span>
    <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;584e8bb7-3ed3-45c3-883a-33260951c59a&#34;</span><span class="p">,</span>
            <span class="nt">&#34;businessPhones&#34;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="nt">&#34;displayName&#34;</span><span class="p">:</span> <span class="s2">&#34;Adele Vance&#34;</span><span class="p">,</span>
            <span class="nt">&#34;givenName&#34;</span><span class="p">:</span> <span class="s2">&#34;Adele&#34;</span><span class="p">,</span>
            <span class="nt">&#34;jobTitle&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nt">&#34;mail&#34;</span><span class="p">:</span> <span class="s2">&#34;AdeleV@demo.o365life.com&#34;</span><span class="p">,</span>
            <span class="nt">&#34;mobilePhone&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nt">&#34;officeLocation&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nt">&#34;preferredLanguage&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nt">&#34;surname&#34;</span><span class="p">:</span> <span class="s2">&#34;Vance&#34;</span><span class="p">,</span>
            <span class="nt">&#34;userPrincipalName&#34;</span><span class="p">:</span> <span class="s2">&#34;AdeleV@demo.o365life.com&#34;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;6e36a8b3-04d9-48f2-bbd5-123c44633dc7&#34;</span><span class="p">,</span>
            <span class="nt">&#34;businessPhones&#34;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="nt">&#34;displayName&#34;</span><span class="p">:</span> <span class="s2">&#34;Alex Wilber&#34;</span><span class="p">,</span>
            <span class="nt">&#34;givenName&#34;</span><span class="p">:</span> <span class="s2">&#34;Alex&#34;</span><span class="p">,</span>
            <span class="nt">&#34;jobTitle&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nt">&#34;mail&#34;</span><span class="p">:</span> <span class="s2">&#34;AlexW@demo.o365life.com&#34;</span><span class="p">,</span>
            <span class="nt">&#34;mobilePhone&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nt">&#34;officeLocation&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nt">&#34;preferredLanguage&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nt">&#34;surname&#34;</span><span class="p">:</span> <span class="s2">&#34;Wilber&#34;</span><span class="p">,</span>
            <span class="nt">&#34;userPrincipalName&#34;</span><span class="p">:</span> <span class="s2">&#34;AlexW@demo.o365life.com&#34;</span>
        <span class="p">}</span>
		<span class="p">]</span>
<span class="p">}</span></code></pre></div></p>

<p>If compared to Azure AD Graph results, there is a lot less information. To get more details, one can use the beta version of the API:</p>

<pre><code>https://graph.microsoft.com/beta/users
</code></pre>

<h2 id="how-to-block-access-to-graph-apis">How to block access to Graph APIs</h2>

<p>Actually, you cannot block access to Graph APIs, as it is in the very core of Azure AD. However, there are two ways you can limit the users&rsquo; access
to Graph API Explorers.</p>

<h3 id="block-users-access-to-others-information">Block users&rsquo; access to others information</h3>

<p>This is quite easy, as you use the same PowerShell command as earlier:
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="c"># Disable users&#39; permission to read others data</span>
<span class="nb">Set-MsolCompanySettings</span> <span class="n">-UsersPermissionToReadOtherUsersEnabled</span> <span class="nv">$false</span></code></pre></div></p>

<p>This only removes users&rsquo; access to others&rsquo; data, so they still can use Graph APIs to query their own data.</p>

<h3 id="disable-graph-api-explorers">Disable Graph API Explorers</h3>

<p>As I mentioned earlier, Microsoft has granted access to all Azure AD tenants for Graph API Explorers.
Luckily, you can disable them for your tenant.</p>

<p>Start by browsing to <a href="https://portal.azure.com" target="_blank">Azure Portal</a> as Global Administrator.
Then select <strong>Azure Active Directory</strong> and open <strong>Enterprise Applications</strong> blade. Now you should see two explorer apps,
<strong>Graph explorer</strong> (Microsoft Graph Explorer) and <strong>Graph Explorer</strong> (Azure AD Graph Explorer).</p>

<p><strong>Note:</strong> Graph explorers will not be shown here unless some user has actually used them.</p>

<p><img src="/images/posts/adgraph-03.png" alt="alt text" /></p>

<p>To disable access, click the first Graph explorer. Open properties and click <strong>No</strong> next to <strong>Enabled for users to sign-in?</strong>
Click save and repeat the steps with the other Graph explorer.</p>

<p><img src="/images/posts/adgraph-04.png" alt="alt text" /></p>

<p>Now, if users are trying to access the Graph explorers, they will have an error like this:</p>

<p><img src="/images/posts/adgraph-05.png" alt="alt text" /></p>
		</div>
		
<div class="post__tags tags clearfix">
	<img class="icon icon-tag" src="/images/tags.png" width="16" height="16" viewBox="0 0 16 16">
	
	<ul class="tags__list">
		<li class="tags__item"><a class="tags__link" href="/tags/azure-active-directory/" rel="tag">Azure Active Directory</a></li>
		<li class="tags__item"><a class="tags__link" href="/tags/security/" rel="tag">Security</a></li>
		<li class="tags__item"><a class="tags__link" href="/tags/powershell/" rel="tag">PowerShell</a></li>
		<li class="tags__item"><a class="tags__link" href="/tags/graph/" rel="tag">Graph</a></li>
	</ul>
</div>

		<div class="post__tags tags clearfix">
<ul class="tags__list">
	<li class="tags__item"><a class="tags__link" href="http://twitter.com/intent/tweet?url=http%3a%2f%2fo365blog.com%2fpost%2flimit-user-access%2f&text=Block%20user%20access%20to%20Azure%20AD%20PowerShell%20and%20Graph%20API%20Explorer&tw_p=tweetbutton" title="Share in Twitter" target="_blank" rel="nofollow"><i class="fa fa-twitter" aria-hidden="true"></i></a></li>
	<li class="tags__item"><a class="tags__link" href="https://www.linkedin.com/shareArticle?url=http%3a%2f%2fo365blog.com%2fpost%2flimit-user-access%2f&mini=true&title=Block%20user%20access%20to%20Azure%20AD%20PowerShell%20and%20Graph%20API%20Explorer&summary=&source=o365blog.com" title="Share in LinkedIn" target="_blank" rel="nofollow"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li>
</ul>
</div>
	</article>
	
<div class="authorbox clearfix">
	<figure class="authorbox__avatar">
		<img alt="Dr Nestori Syynimaa (@DrAzureAD) avatar" src="/images/nestori.jpg" class="avatar" height="90" width="90">
	</figure>
	<div class="authorbox__header">
		<span class="authorbox__name">About Dr Nestori Syynimaa (@DrAzureAD)</span>
	</div>
	<div class="authorbox__description">
		Dr Syynimaa works as Senior Principal Information Security Researcher at Secureworks CTU (Counter Threat Unit). <br> Before moving to his current position, Dr Syynimaa worked as a CIO, consultant, trainer, and university lecturer for over 20 years. He is a regular speaker in scientific and professional conferences related to Microsoft 365 and Azure AD security. <br><br>Dr Syynimaa is Microsoft Certified Expert (Microsoft 365), Microsoft Certified Azure Solutions Architect Expert, Microsoft Certified Trainer, Microsoft MVP (Enterprise Mobility, Identity and Access &amp; Intune), and Microsoft Most Valuable Security Researcher (MVR).
	</div>
</div>
	
<nav class="post-nav row clearfix" itemscope="itemscope" itemtype="http://schema.org/SiteNavigationElement">
	<div class="post-nav__item post-nav__item--prev col-1-2">
		<a class="post-nav__link" href="/post/teams-free/" rel="prev"><span class="post-nav__caption">«Previous</span><p class="post-nav__post-title">Technical deep dive to Microsoft Teams (free)</p></a>
	</div>
	<div class="post-nav__item post-nav__item--next col-1-2">
		<a class="post-nav__link" href="/post/aadinternals/" rel="next"><span class="post-nav__caption">Next»</span><p class="post-nav__post-title">AADInternals published!</p></a>
	</div>
</nav>

	
<div class="comments">
	<div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "o365blog-com" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

</main>

<aside class="sidebar" itemscope="itemscope" itemtype="http://schema.org/WPSideBar">
	
<div class="widget-search widget">
	<form class="widget-search__form" role="search" method="get" action="//google.com/search">
		<label>
			<span class="screen-reader-text">Search for:</span>
			<input class="widget-search__field" type="search" placeholder="SEARCH..." value="" name="q">
		</label>
		<input class="widget-search__submit" type="submit" value="Search">
		<input type="hidden" name="sitesearch" value="http://o365blog.com" />
	</form>
</div>
	
<div class="widget-recent widget">
	<h4 class="widget__title">Recent Posts</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/post/pta/">Exploiting Azure AD PTA vulnerabilities: Creating backdoor and harvesting credentials</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/gmsa/">Hunt for the gMSA secrets</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/august_2022/">AADInternals World Tour August 2022: USA</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/deviceidentity/">Stealing and faking Azure AD device identities</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/partners/">Microsoft partners: The Good, The Bad, or The Ugly?</a></li>
		</ul>
	</div>
</div>

	
<div class="widget-categories widget">
	<h4 class="widget__title">Categories</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/categories/"></a></li>
			<li class="widget__item"><a class="widget__link" href="/categories/article">Article</a></li>
			<li class="widget__item"><a class="widget__link" href="/categories/blog">Blog</a></li>
		</ul>
	</div>
</div>
	
<div class="widget-social widget">
	<h4 class="widget-social__title widget__title">Social</h4>
	<div class="widget-social__content widget__content">
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="Twitter" rel="noopener noreferrer" href="https://twitter.com/DrAzureAD" target="_blank">
				<svg class="widget-social__link-icon icon-twitter" viewBox="0 0 384 312" width="24" height="24" xmlns="http://www.w3.org/2000/svg" fill="#fff"><path d="m384 36.9c-14.1 6.3-29.3 10.5-45.2 12.4 16.3-9.7 28.8-25.2 34.6-43.6-15.2 9-32.1 15.6-50 19.1-14.4-15.2-34.9-24.8-57.5-24.8-43.5 0-78.8 35.3-78.8 78.8 0 6.2.7 12.2 2 17.9-65.5-3.3-123.5-34.6-162.4-82.3-6.7 11.6-10.6 25.2-10.6 39.6 0 27.3 13.9 51.4 35 65.6-12.9-.4-25.1-4-35.7-9.9v1c0 38.2 27.2 70 63.2 77.2-6.6 1.8-13.6 2.8-20.8 2.8-5.1 0-10-.5-14.8-1.4 10 31.3 39.1 54.1 73.6 54.7-27 21.1-60.9 33.7-97.8 33.7-6.4 0-12.6-.4-18.8-1.1 34.9 22.4 76.3 35.4 120.8 35.4 144.9 0 224.1-120 224.1-224.1 0-3.4-.1-6.8-.2-10.2 15.4-11.1 28.7-25 39.3-40.8z"/></svg>
				<span>Twitter</span>
			</a>
		</div>
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="" rel="noopener noreferrer" href="https://linkedin.com/in/nestori" target="_blank">
				<svg class="widget-social__link-icon icon-linkedin" viewBox="0 0 352 352" width="24" height="24" fill="#fff" xmlns="http://www.w3.org/2000/svg"><path d="M0,40v272c0,21.9,18.1,40,40,40h272c21.9,0,40-18.1,40-40V40c0-21.9-18.1-40-40-40H40C18.1,0,0,18.1,0,40z M312,32 c4.6,0,8,3.4,8,8v272c0,4.6-3.4,8-8,8H40c-4.6,0-8-3.4-8-8V40c0-4.6,3.4-8,8-8H312z M59.5,87c0,15.2,12.3,27.5,27.5,27.5 c15.2,0,27.5-12.3,27.5-27.5c0-15.2-12.3-27.5-27.5-27.5C71.8,59.5,59.5,71.8,59.5,87z M187,157h-1v-21h-45v152h47v-75 c0-19.8,3.9-39,28.5-39c24.2,0,24.5,22.4,24.5,40v74h47v-83.5c0-40.9-8.7-72-56.5-72C208.5,132.5,193.3,145.1,187,157z M64,288h47.5 V136H64V288z"/></svg>
				<span>LinkedIn</span>
			</a>
		</div>
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="Email" href="mailto:nestori.syynimaa@gerenios.com">
				<svg class="widget-social__link-icon icon-mail" viewBox="0 0 416 288" width="24" height="24" xmlns="http://www.w3.org/2000/svg" fill="#fff"><path d="m0 16v256 16h16 384 16v-16-256-16h-16-384-16zm347 16-139 92.5-139-92.5zm-148 125.5 9 5.5 9-5.5 167-111.5v210h-352v-210z"/></svg>
				<span>nestori.syynimaa@gerenios.com</span>
			</a>
		</div>
	</div>
</div>

	
<div class="widget-taglist widget">
	<h4 class="widget__title">Tags</h4>
	<div class="widget__content">
		<a class="widget__link widget__link--taglist" href="/tags/aadconnect" title="aadconnect">aadconnect (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/aadinternals" title="aadinternals">aadinternals (10)</a>
		<a class="widget__link widget__link--taglist" href="/tags/abusing" title="abusing">abusing (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/active-directory" title="active-directory">active-directory (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/adfs" title="adfs">adfs (5)</a>
		<a class="widget__link widget__link--taglist" href="/tags/admin" title="admin">admin (3)</a>
		<a class="widget__link widget__link--taglist" href="/tags/administration" title="administration">administration (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/authentication" title="authentication">authentication (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/azure" title="azure">azure (20)</a>
		<a class="widget__link widget__link--taglist" href="/tags/azure-active-directory" title="azure-active-directory">azure-active-directory (27)</a>
		<a class="widget__link widget__link--taglist" href="/tags/azuread" title="azuread">azuread (4)</a>
		<a class="widget__link widget__link--taglist" href="/tags/backdoor" title="backdoor">backdoor (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/blackhat" title="blackhat">blackhat (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/blue-team" title="blue-team">blue-team (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/bprt" title="bprt">bprt (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/browser" title="browser">browser (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/compromise" title="compromise">compromise (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/conferences" title="conferences">conferences (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/defcon" title="defcon">defcon (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/desktop-sso" title="desktop-sso">desktop-sso (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/device" title="device">device (3)</a>
		<a class="widget__link widget__link--taglist" href="/tags/dns" title="dns">dns (3)</a>
		<a class="widget__link widget__link--taglist" href="/tags/email" title="email">email (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/encryption" title="encryption">encryption (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/exchange" title="exchange">exchange (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/federation" title="federation">federation (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/forensics" title="forensics">forensics (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/gdpr" title="gdpr">gdpr (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/global-administrator" title="global-administrator">global-administrator (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/graph" title="graph">graph (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/groups" title="groups">groups (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/guest" title="guest">guest (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/hybrid-join" title="hybrid-join">hybrid-join (3)</a>
		<a class="widget__link widget__link--taglist" href="/tags/identity" title="identity">identity (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/inactive" title="inactive">inactive (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/insider" title="insider">insider (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/intune" title="intune">intune (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/join" title="join">join (3)</a>
		<a class="widget__link widget__link--taglist" href="/tags/logs" title="logs">logs (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/mailbox" title="mailbox">mailbox (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/mdm" title="mdm">mdm (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/mfa" title="mfa">mfa (6)</a>
		<a class="widget__link widget__link--taglist" href="/tags/office-365" title="office-365">office-365 (9)</a>
		<a class="widget__link widget__link--taglist" href="/tags/office365" title="office365">office365 (9)</a>
		<a class="widget__link widget__link--taglist" href="/tags/on-prem" title="on-prem">on-prem (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/onedrive" title="onedrive">onedrive (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/outsider" title="outsider">outsider (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/partner" title="partner">partner (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/password" title="password">password (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/persistence" title="persistence">persistence (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/phishing" title="phishing">phishing (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/planner" title="planner">planner (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/powershell" title="powershell">powershell (13)</a>
		<a class="widget__link widget__link--taglist" href="/tags/prt" title="prt">prt (6)</a>
		<a class="widget__link widget__link--taglist" href="/tags/pta" title="pta">pta (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/recon" title="recon">recon (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/reconnaissance" title="reconnaissance">reconnaissance (4)</a>
		<a class="widget__link widget__link--taglist" href="/tags/seamless-sso" title="seamless-sso">seamless-sso (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/security" title="security">security (31)</a>
		<a class="widget__link widget__link--taglist" href="/tags/sso" title="sso">sso (2)</a>
		<a class="widget__link widget__link--taglist" href="/tags/sync" title="sync">sync (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/synchronisation" title="synchronisation">synchronisation (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/t2" title="t2">t2 (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/talks" title="talks">talks (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/teams" title="teams">teams (3)</a>
		<a class="widget__link widget__link--taglist" href="/tags/user" title="user">user (1)</a>
		<a class="widget__link widget__link--taglist" href="/tags/virtual-machine" title="virtual-machine">virtual-machine (1)</a>
	</div>
</div>
</aside>

	</div>
		<footer class="footer" itemscope="itemscope" itemtype="http://schema.org/WPFooter">
			<div class="container container-inner">
				<p class="footer__copyright"><span><a href="https://creativecommons.org/licenses/by/4.0/" target="_blank"><img src="/images/CC-BY.png"></a> </span></p>
			</div>
		</footer>
	</div>

<script>
	var navigation = responsiveNav(".menu", {
		navClass: "menu--collapse",
	});
</script>
</body>
</html>
